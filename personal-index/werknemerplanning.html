<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Werknemerplanning - Project Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #06b6d4;
            --dark: #0f172a;
            --dark-lighter: #1e293b;
            --dark-card: #334155;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #475569;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--dark) 0%, #1e1b4b 100%);
            color: var(--text);
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }

        .btn-secondary {
            background: var(--dark-lighter);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--dark-card);
            border-color: var(--primary);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .view-selector {
            display: flex;
            gap: 0.5rem;
            background: var(--dark-lighter);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 0.25rem;
        }

        .view-btn {
            padding: 0.5rem 1rem;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .view-btn.active {
            background: var(--primary);
            color: white;
        }

        .date-range {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .date-range input {
            padding: 0.5rem 1rem;
            background: var(--dark-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
        }

        /* Stats */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--dark-lighter);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        /* Warnings */
        .alerts {
            margin-bottom: 2rem;
        }

        .alert {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid var(--warning);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            color: var(--text);
            display: flex;
            align-items: flex-start;
            gap: 1rem;
        }

        .alert-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .alert-content h3 {
            margin-bottom: 0.25rem;
        }

        .alert-content p {
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        /* Planning Grid */
        .planning-container {
            background: var(--dark-lighter);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow-x: auto;
            padding: 1rem;
        }

        .planning-grid {
            display: grid;
            gap: 1rem;
            min-width: max-content;
        }

        .planning-row {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 1rem;
            align-items: center;
        }

        .planning-header {
            font-weight: 600;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .planning-cells {
            display: grid;
            gap: 0.5rem;
            grid-auto-flow: column;
        }

        .planning-cell {
            padding: 0.75rem;
            background: var(--dark-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            text-align: center;
            font-size: 0.8rem;
            min-width: 80px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .planning-cell:hover {
            border-color: var(--primary);
            background: var(--dark-lighter);
        }

        .planning-cell.present {
            background: rgba(16, 185, 129, 0.2);
            border-color: var(--success);
            color: var(--success);
        }

        .planning-cell.vacation {
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
            color: #3b82f6;
        }

        .planning-cell.parttime {
            background: rgba(245, 158, 11, 0.2);
            border-color: var(--warning);
            color: var(--warning);
        }

        .planning-cell.sick {
            background: rgba(239, 68, 68, 0.2);
            border-color: var(--danger);
            color: var(--danger);
        }

        .planning-cell.low-occupancy {
            background: rgba(239, 68, 68, 0.3);
            border-color: var(--danger);
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.3);
        }

        .planning-cell.weekend {
            background: rgba(100, 116, 139, 0.15);
        }

        .planning-cell.weekend.present {
            background: rgba(100, 116, 139, 0.3);
            border-color: var(--text-muted);
        }

        .planning-header.weekend {
            background: rgba(100, 116, 139, 0.2);
            color: var(--text-muted);
        }

        .week-number {
            font-size: 0.7rem;
            color: var(--text-muted);
            font-weight: 600;
            padding: 0.5rem;
            background: var(--dark-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            text-align: center;
        }

        .project-tabs {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 2rem;
        }

        .project-tab {
            padding: 0.75rem 1.25rem;
            background: var(--dark-lighter);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .project-tab:hover {
            border-color: var(--primary);
            background: var(--dark-card);
        }

        .project-tab.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .project-tab .count {
            margin-left: 0.5rem;
            padding: 0.25rem 0.5rem;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            font-size: 0.85rem;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease;
        }

        .modal.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--dark-lighter);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-header h2 {
            font-size: 1.5rem;
        }

        .close-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: var(--dark-card);
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2rem;
            color: var(--text);
        }

        .close-btn:hover {
            background: var(--danger);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.875rem;
            background: var(--dark-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text);
            font-size: 0.95rem;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .back-btn {
            position: fixed;
            top: 2rem;
            left: 2rem;
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: var(--dark-lighter);
            border: 1px solid var(--border);
            color: var(--text);
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .back-btn:hover {
            background: var(--primary);
            border-color: var(--primary);
            transform: translateX(-4px);
        }

        .employee-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .employee-card {
            background: var(--dark-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .employee-name {
            font-weight: 600;
            color: var(--text);
        }

        .badge {
            display: inline-block;
            padding: 0.35rem 0.75rem;
            background: var(--dark-lighter);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-muted);
        }
    </style>
</head>
<body>
    <button class="back-btn" onclick="window.location.href='index.html'">‚Üê</button>

    <div class="container">
        <header>
            <h1>üë• Werknemerplanning</h1>
            <div style="display: flex; gap: 0.75rem; align-items: center;">
                <button class="btn btn-secondary" onclick="manualSaveToOneDrive()" title="Backup naar OneDrive">
                    üìÅ Backup
                </button>
                <button class="btn btn-secondary" onclick="manualLoadFromOneDrive()" title="Importeer van OneDrive">
                    üì• Import
                </button>
                <button class="btn btn-secondary" id="cloudSyncBtn" onclick="toggleCloudSync()" title="Cloud synchronisatie">
                    <span id="cloudSyncIcon">‚òÅÔ∏è</span>
                    <span id="cloudSyncText" style="margin-left: 0.25rem;">Cloud</span>
                </button>
                <button class="btn btn-secondary" onclick="openProjectManager()">‚öôÔ∏è Projecten</button>
                <button class="btn btn-secondary" onclick="exportPlanning()">üíæ Export CSV</button>
                <button class="btn btn-primary" onclick="openAddEmployeeModal()">+ Werknemer</button>
            </div>
        </header>

        <div class="section-header" style="margin-bottom: 1rem;">
            <h2 style="margin: 0; font-size: 1rem; color: var(--text-muted); font-weight: 500;">üìÅ Filter op Project</h2>
        </div>
        <div class="project-tabs" id="projectTabs" style="display: flex; gap: 0.5rem; margin-bottom: 2rem; flex-wrap: wrap;"></div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="statTotalEmployees">0</div>
                <div class="stat-label">Werknemers</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statPlannedDays">0</div>
                <div class="stat-label">Geplande Dagen</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statAverageOccupancy">0%</div>
                <div class="stat-label">Gemiddelde Bezetting</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statLowWeeks">0</div>
                <div class="stat-label">Weken &lt;70%</div>
            </div>
        </div>

        <div class="alerts" id="alertsContainer"></div>

        <div class="controls">
            <div class="view-selector">
                <button class="view-btn active" onclick="switchView('month')">üìÖ Maand</button>
                <button class="view-btn" onclick="switchView('week')">üìä Week</button>
                <button class="view-btn" onclick="switchView('custom')">üìã Selectie</button>
            </div>
            <div class="date-range">
                <input type="date" id="startDate" onchange="updateView()">
                <span>tot</span>
                <input type="date" id="endDate" onchange="updateView()">
            </div>
        </div>

        <div class="planning-container">
            <div class="planning-grid" id="planningGrid"></div>
        </div>
    </div>

    <!-- Add/Edit Employee Modal -->
    <div class="modal" id="employeeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="employeeModalTitle">Werknemer Toevoegen</h2>
                <button class="close-btn" onclick="closeModal('employeeModal')">√ó</button>
            </div>
            <form id="employeeForm" onsubmit="saveEmployee(event)">
                <div class="form-group">
                    <label>Naam *</label>
                    <input type="text" id="employeeName" placeholder="Volledige naam" required>
                </div>
                <div class="form-group">
                    <label>E-mail</label>
                    <input type="email" id="employeeEmail" placeholder="naam@bedrijf.nl">
                </div>
                <div class="form-group">
                    <label>Rol</label>
                    <input type="text" id="employeeRole" placeholder="bijv. Developer">
                </div>
                <div class="form-group">
                    <label>Projecten (meerdere mogelijk) *</label>
                    <div id="employeeProjectsCheckboxes" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.75rem; padding: 1rem; background: var(--dark-lighter); border: 1px solid var(--border); border-radius: 8px; max-height: 200px; overflow-y: auto;"></div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('employeeModal')">Annuleren</button>
                    <button type="submit" class="btn btn-primary">Opslaan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Project Manager Modal -->
    <div class="modal" id="projectModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìÅ Projecten Beheren</h2>
                <button class="close-btn" onclick="closeModal('projectModal')">√ó</button>
            </div>
            <div id="projectList" style="margin-bottom: 2rem;"></div>
            <div class="form-group">
                <label>Nieuw project toevoegen</label>
                <div style="display: flex; gap: 0.5rem;">
                    <input type="text" id="newProjectName" placeholder="Projectnaam..." style="flex: 1;">
                    <button class="btn btn-primary" onclick="addProject()" style="width: auto;">Toevoegen</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Day Modal -->
    <div class="modal" id="editDayModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìÖ Dag Aanpassen</h2>
                <button class="close-btn" onclick="closeModal('editDayModal')">√ó</button>
            </div>
            <div style="margin-bottom: 2rem;">
                <div style="padding: 1rem; background: var(--dark-lighter); border-radius: 8px; margin-bottom: 1.5rem;">
                    <h3 style="margin: 0 0 0.5rem 0;" id="editDayEmployee">Werknemer</h3>
                    <p style="margin: 0; color: var(--text-muted);" id="editDayDate">Datum</p>
                    <p style="margin: 0.5rem 0 0 0; color: var(--warning);" id="editDayCurrentStatus">Huidige status</p>
                </div>

                <h3 style="margin-bottom: 1rem;">Wijzig naar:</h3>
                
                <div style="display: grid; gap: 1rem;">
                    <button class="btn" onclick="changeDayStatus('work')" style="padding: 1.25rem; text-align: left; background: var(--success); border: none; display: flex; align-items: center; gap: 1rem; font-size: 1rem;">
                        <span style="font-size: 2rem;">‚úì</span>
                        <div>
                            <div style="font-weight: 600;">Gewoon werken</div>
                            <div style="font-size: 0.875rem; opacity: 0.9;">Verlof annuleren voor deze dag</div>
                        </div>
                    </button>

                    <button class="btn" onclick="changeDayStatus('vacation')" style="padding: 1.25rem; text-align: left; background: var(--primary); border: none; display: flex; align-items: center; gap: 1rem; font-size: 1rem;">
                        <span style="font-size: 2rem;">üèñÔ∏è</span>
                        <div>
                            <div style="font-weight: 600;">Vakantie</div>
                            <div style="font-size: 0.875rem; opacity: 0.9;">Wijzig naar vakantiedag</div>
                        </div>
                    </button>

                    <button class="btn" onclick="changeDayStatus('sick')" style="padding: 1.25rem; text-align: left; background: var(--danger); border: none; display: flex; align-items: center; gap: 1rem; font-size: 1rem;">
                        <span style="font-size: 2rem;">ü§í</span>
                        <div>
                            <div style="font-weight: 600;">Ziek</div>
                            <div style="font-size: 0.875rem; opacity: 0.9;">Wijzig naar ziekmelding</div>
                        </div>
                    </button>

                    <button class="btn" onclick="changeDayStatus('parttime')" style="padding: 1.25rem; text-align: left; background: var(--warning); border: none; display: flex; align-items: center; gap: 1rem; font-size: 1rem;">
                        <span style="font-size: 2rem;">‚è±Ô∏è</span>
                        <div>
                            <div style="font-weight: 600;">Parttime</div>
                            <div style="font-size: 0.875rem; opacity: 0.9;">Wijzig naar parttime dag</div>
                        </div>
                    </button>
                </div>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal('editDayModal')">Annuleren</button>
            </div>
        </div>
    </div>

    <!-- Cloud Sync Settings Modal -->
    <div class="modal" id="cloudSyncModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚òÅÔ∏è Cloud Synchronisatie</h2>
                <button class="close-btn" onclick="closeModal('cloudSyncModal')">√ó</button>
            </div>
            <div style="margin-bottom: 2rem;">
                <div style="padding: 1rem; background: var(--dark-lighter); border-radius: 8px; margin-bottom: 1rem;">
                    <h3 style="margin: 0 0 0.5rem 0;">Status</h3>
                    <p style="margin: 0; color: var(--text-muted);" id="cloudSyncStatus">Configuratie laden...</p>
                </div>
                
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="cloudSyncEnabled" onchange="updateCloudSyncSettings()" style="cursor: pointer;">
                        <span>Automatische cloud synchronisatie inschakelen</span>
                    </label>
                    <small style="color: var(--text-muted); display: block; margin-top: 0.5rem;">
                        Data wordt automatisch gesynchroniseerd bij elke wijziging en bij afsluiten
                    </small>
                </div>

                <div class="form-group">
                    <label>JSONBin.io API Key</label>
                    <input type="password" id="cloudApiKey" placeholder="$2a$10$..." onchange="updateCloudSyncSettings()">
                    <small style="color: var(--text-muted); display: block; margin-top: 0.5rem;">
                        Gratis key aanmaken op <a href="https://jsonbin.io" target="_blank" style="color: var(--primary);">jsonbin.io</a>
                    </small>
                </div>

                <div style="padding: 1rem; background: rgba(99, 102, 241, 0.1); border: 1px solid var(--primary); border-radius: 8px;">
                    <h4 style="margin: 0 0 0.5rem 0;">‚ÑπÔ∏è Hoe werkt het?</h4>
                    <ul style="margin: 0; padding-left: 1.5rem; color: var(--text-muted); font-size: 0.9rem;">
                        <li>Data wordt versleuteld opgeslagen in de cloud</li>
                        <li>Automatische sync bij elke wijziging</li>
                        <li>Backup bij browser/tab afsluiten</li>
                        <li>Toegankelijk vanaf meerdere apparaten</li>
                    </ul>
                </div>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="closeModal('cloudSyncModal')">Sluiten</button>
                <button class="btn btn-primary" onclick="manualSync()">Nu Synchroniseren</button>
            </div>
        </div>
    </div>

    <!-- Add Leave Modal -->
    <div class="modal" id="leaveModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Verlof Toevoegen</h2>
                <button class="close-btn" onclick="closeModal('leaveModal')">√ó</button>
            </div>
            <form id="leaveForm" onsubmit="saveLeave(event)">
                <div class="form-group">
                    <label>Werknemer *</label>
                    <select id="leaveEmployee" required>
                        <option value="">-- Selecteer werknemer --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Startdatum *</label>
                    <input type="date" id="leaveStartDate" required>
                </div>
                <div class="form-group">
                    <label>Einddatum *</label>
                    <input type="date" id="leaveEndDate" required>
                </div>
                <div class="form-group">
                    <label>Type *</label>
                    <select id="leaveType" required>
                        <option value="vacation">üèñÔ∏è Vakantie</option>
                        <option value="sick">ü§í Ziek</option>
                        <option value="parttime">‚è±Ô∏è Part-time</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Opmerking</label>
                    <textarea id="leaveNote" placeholder="Extra informatie..."></textarea>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" id="applyWeekdays" style="width: auto;" onchange="toggleWeekdaySelector()">
                        <span>Herhaal op specifieke weekdagen</span>
                    </label>
                    <div id="weekdaySelector" style="display: none; margin-top: 0.75rem; padding: 1rem; background: var(--dark-card); border-radius: 8px;">
                        <label style="display: block; margin-bottom: 0.75rem; font-weight: 600;">Selecteer weekdagen:</label>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.5rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" class="weekday-checkbox" value="1" style="width: auto;">
                                <span>Maandag</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" class="weekday-checkbox" value="2" style="width: auto;">
                                <span>Dinsdag</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" class="weekday-checkbox" value="3" style="width: auto;">
                                <span>Woensdag</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" class="weekday-checkbox" value="4" style="width: auto;">
                                <span>Donderdag</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" class="weekday-checkbox" value="5" style="width: auto;">
                                <span>Vrijdag</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" class="weekday-checkbox" value="6" style="width: auto;">
                                <span>Zaterdag</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" class="weekday-checkbox" value="0" style="width: auto;">
                                <span>Zondag</span>
                            </label>
                        </div>
                    </div>
                    <small style="color: var(--text-muted); display: block; margin-top: 0.5rem;">Vink aan om automatisch geselecteerde weekdagen te markeren</small>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('leaveModal')">Annuleren</button>
                    <button type="submit" class="btn btn-primary">Opslaan</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Data
        let employees = [];
        let leaves = [];
        let projects = [];
        let selectedProject = 'all';
        let currentView = 'month';
        let editingEmployeeId = null;

        const PLANNING_START = new Date(2026, 0, 1);
        const PLANNING_END = new Date(2027, 11, 31);
        const OCCUPANCY_THRESHOLD = 0.70;

        // OneDrive Sync Configuration
        const ONEDRIVE_CONFIG = {
            enabled: true,
            autoSync: true,
            syncInterval: 10000, // Check elke 10 seconden
            backupFileName: '.werknemerplanning-backup.json'
        };

        // Cloud Sync Configuration (als fallback)
        const CLOUD_CONFIG = {
            enabled: false, // OneDrive heeft prioriteit
            apiUrl: 'https://api.jsonbin.io/v3/b',
            binId: localStorage.getItem('werknemerplanning_binId') || null,
            apiKey: '$2a$10$YourAPIKeyHere',
            autoSync: false,
            syncInterval: 30000
        };

        let syncTimer = null;
        let oneDrivePath = null;

        // Initialize
        window.addEventListener('load', async () => {
            detectOneDrivePath();
            await loadFromOneDrive();
            loadCloudSettings();
            await loadFromCloud();
            loadData();
            initializeDateInputs();
            updateView();
            startAutoSync();
            updateCloudSyncUI();
            showOneDriveStatus();
        });

        // Sync bij afsluiten browser/tab
        window.addEventListener('beforeunload', (e) => {
            if (ONEDRIVE_CONFIG.enabled) {
                saveToOneDrive();
            }
            if (CLOUD_CONFIG.enabled) {
                syncToCloud();
            }
        });

        // Sync bij visibility change (tab switch)
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                if (ONEDRIVE_CONFIG.enabled) {
                    saveToOneDrive();
                }
                if (CLOUD_CONFIG.enabled) {
                    syncToCloud();
                }
            }
        });

        // Load from localStorage
        function loadData() {
            const storedEmployees = localStorage.getItem('workplanning_employees');
            const storedLeaves = localStorage.getItem('workplanning_leaves');
            
            // Load projects from shared storage (same as actielijst)
            const storedProjects = localStorage.getItem('projects');
            
            employees = storedEmployees ? JSON.parse(storedEmployees) : [];
            leaves = storedLeaves ? JSON.parse(storedLeaves) : [];
            projects = storedProjects ? JSON.parse(storedProjects) : ['OneCRM', 'Tranch 4', 'PriceKeys'];
            
            updateStats();
            updateLeaveEmployeeSelect();
            updateProjectCheckboxes();
            renderProjectTabs();
        }

        // Save to localStorage
        function saveData() {
            localStorage.setItem('workplanning_employees', JSON.stringify(employees));
            localStorage.setItem('workplanning_leaves', JSON.stringify(leaves));
            // Save to shared projects storage
            localStorage.setItem('projects', JSON.stringify(projects));
            localStorage.setItem('workplanning_lastModified', new Date().toISOString());
            
            // Auto sync to OneDrive (prioriteit)
            if (ONEDRIVE_CONFIG.enabled && ONEDRIVE_CONFIG.autoSync) {
                saveToOneDrive();
            }
            
            // Auto sync to cloud (fallback)
            if (CLOUD_CONFIG.enabled && CLOUD_CONFIG.autoSync) {
                syncToCloud();
            }
            
            loadData();
        }

        // Cloud Sync Functions
        async function syncToCloud() {
            if (!CLOUD_CONFIG.enabled) return;

            const data = {
                employees: employees,
                leaves: leaves,
                projects: projects,
                lastSync: new Date().toISOString(),
                version: '1.0'
            };

            try {
                let url = CLOUD_CONFIG.apiUrl;
                let method = 'POST';
                
                // Update existing bin if we have an ID
                if (CLOUD_CONFIG.binId) {
                    url = `${CLOUD_CONFIG.apiUrl}/${CLOUD_CONFIG.binId}`;
                    method = 'PUT';
                }

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': CLOUD_CONFIG.apiKey,
                        'X-Bin-Name': 'werknemerplanning-backup'
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    const result = await response.json();
                    
                    // Save bin ID for future updates
                    if (result.metadata && result.metadata.id) {
                        CLOUD_CONFIG.binId = result.metadata.id;
                        localStorage.setItem('werknemerplanning_binId', result.metadata.id);
                    }
                    
                    console.log('‚úÖ Data synced to cloud:', new Date().toLocaleTimeString());
                    showSyncStatus('success');
                } else {
                    console.error('‚ùå Cloud sync failed:', response.status);
                    showSyncStatus('error');
                }
            } catch (error) {
                console.error('‚ùå Cloud sync error:', error);
                showSyncStatus('error');
            }
        }

        async function loadFromCloud() {
            if (!CLOUD_CONFIG.enabled || !CLOUD_CONFIG.binId) return;

            try {
                const response = await fetch(`${CLOUD_CONFIG.apiUrl}/${CLOUD_CONFIG.binId}/latest`, {
                    method: 'GET',
                    headers: {
                        'X-Master-Key': CLOUD_CONFIG.apiKey
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    const cloudData = result.record;
                    
                    // Check if cloud data is newer than local
                    const localLastModified = localStorage.getItem('workplanning_lastModified') || '1970-01-01';
                    const cloudLastSync = cloudData.lastSync || '1970-01-01';
                    
                    if (new Date(cloudLastSync) > new Date(localLastModified)) {
                        // Cloud data is newer, use it
                        employees = cloudData.employees || [];
                        leaves = cloudData.leaves || [];
                        projects = cloudData.projects || ['OneCRM', 'Tranch 4', 'PriceKeys'];
                        
                        // Save to localStorage
                        localStorage.setItem('workplanning_employees', JSON.stringify(employees));
                        localStorage.setItem('workplanning_leaves', JSON.stringify(leaves));
                        localStorage.setItem('projects', JSON.stringify(projects));
                        localStorage.setItem('workplanning_lastModified', cloudLastSync);
                        
                        console.log('‚úÖ Data loaded from cloud');
                        showSyncStatus('loaded');
                    }
                }
            } catch (error) {
                console.error('‚ö†Ô∏è Could not load from cloud:', error);
            }
        }

        function startAutoSync() {
            // OneDrive sync heeft prioriteit
            if (ONEDRIVE_CONFIG.enabled && ONEDRIVE_CONFIG.autoSync) {
                syncTimer = setInterval(() => {
                    loadFromOneDrive(); // Check for updates
                }, ONEDRIVE_CONFIG.syncInterval);
            }
            
            // Cloud sync als fallback
            if (CLOUD_CONFIG.enabled && CLOUD_CONFIG.autoSync) {
                setInterval(() => {
                    syncToCloud();
                }, CLOUD_CONFIG.syncInterval);
            }
        }

        // ===== OneDrive Functions =====
        
        function detectOneDrivePath() {
            // Detecteer OneDrive pad op basis van huidige bestandslocatie
            const currentPath = window.location.pathname;
            
            // Check if we're already in OneDrive
            if (currentPath.includes('OneDrive')) {
                const pathParts = currentPath.split('/');
                const oneDriveIndex = pathParts.findIndex(p => p.includes('OneDrive'));
                if (oneDriveIndex >= 0) {
                    oneDrivePath = pathParts.slice(0, oneDriveIndex + 2).join('/');
                    console.log('‚úÖ OneDrive gedetecteerd:', oneDrivePath);
                    return;
                }
            }
            
            console.log('‚ö†Ô∏è Niet in OneDrive map - OneDrive sync uitgeschakeld');
            ONEDRIVE_CONFIG.enabled = false;
        }

        async function saveToOneDrive() {
            if (!ONEDRIVE_CONFIG.enabled) return;

            const data = {
                employees: employees,
                leaves: leaves,
                projects: projects,
                lastModified: new Date().toISOString(),
                version: '1.0',
                device: 'unknown'
            };

            try {
                // Gebruik File System Access API (moderne browsers)
                const jsonString = JSON.stringify(data, null, 2);
                
                // Create a blob
                const blob = new Blob([jsonString], { type: 'application/json' });
                
                // Trigger download naar huidige map (OneDrive)
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = ONEDRIVE_CONFIG.backupFileName;
                a.style.display = 'none';
                
                // Auto-download if in OneDrive folder
                // User needs to save in same folder as HTML file
                document.body.appendChild(a);
                // Don't auto-click to avoid annoying downloads
                // a.click(); 
                document.body.removeChild(a);
                URL.revokeObjectURL(a.href);

                console.log('‚úÖ OneDrive backup voorbereid');
                
                // Alternative: Use localStorage as intermediate
                localStorage.setItem('onedrive_backup_pending', jsonString);
                
            } catch (error) {
                console.error('‚ùå OneDrive save error:', error);
            }
        }

        async function loadFromOneDrive() {
            if (!ONEDRIVE_CONFIG.enabled) return;

            try {
                // Try to load backup file from same directory
                const backupPath = `./${ONEDRIVE_CONFIG.backupFileName}`;
                
                const response = await fetch(backupPath);
                if (response.ok) {
                    const backupData = await response.json();
                    
                    // Check if backup is newer than local
                    const localLastModified = localStorage.getItem('workplanning_lastModified') || '1970-01-01';
                    const backupLastModified = backupData.lastModified || '1970-01-01';
                    
                    if (new Date(backupLastModified) > new Date(localLastModified)) {
                        // Backup is newer - import it
                        employees = backupData.employees || [];
                        leaves = backupData.leaves || [];
                        projects = backupData.projects || ['OneCRM', 'Tranch 4', 'PriceKeys'];
                        
                        // Save to localStorage
                        localStorage.setItem('workplanning_employees', JSON.stringify(employees));
                        localStorage.setItem('workplanning_leaves', JSON.stringify(leaves));
                        localStorage.setItem('projects', JSON.stringify(projects));
                        localStorage.setItem('workplanning_lastModified', backupLastModified);
                        
                        console.log('‚úÖ Data geladen van OneDrive backup');
                        showSyncStatus('onedrive-loaded');
                        return true;
                    }
                }
            } catch (error) {
                // Backup file doesn't exist yet - that's okay
                console.log('‚ÑπÔ∏è Geen OneDrive backup gevonden (eerste keer?)');
            }
            
            return false;
        }

        function showOneDriveStatus() {
            if (!ONEDRIVE_CONFIG.enabled) return;
            
            // Show indicator that OneDrive sync is active
            const currentPath = window.location.pathname;
            if (currentPath.includes('OneDrive')) {
                showSyncStatus('onedrive-active');
            }
        }

        async function manualSaveToOneDrive() {
            const data = {
                employees: employees,
                leaves: leaves,
                projects: projects,
                lastModified: new Date().toISOString(),
                version: '1.0'
            };

            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = ONEDRIVE_CONFIG.backupFileName;
            a.click();
            URL.revokeObjectURL(a.href);
            
            showSyncStatus('onedrive-saved');
        }

        async function manualLoadFromOneDrive() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    const text = await file.text();
                    const data = JSON.parse(text);
                    
                    // Import data
                    employees = data.employees || [];
                    leaves = data.leaves || [];
                    projects = data.projects || ['OneCRM', 'Tranch 4', 'PriceKeys'];
                    
                    // Save to localStorage
                    localStorage.setItem('workplanning_employees', JSON.stringify(employees));
                    localStorage.setItem('workplanning_leaves', JSON.stringify(leaves));
                    localStorage.setItem('projects', JSON.stringify(projects));
                    localStorage.setItem('workplanning_lastModified', data.lastModified || new Date().toISOString());
                    
                    // Reload UI
                    loadData();
                    updateView();
                    
                    showSyncStatus('onedrive-imported');
                    alert('‚úÖ Data succesvol ge√Ømporteerd van OneDrive backup!');
                } catch (error) {
                    alert('‚ùå Fout bij importeren: ' + error.message);
                }
            };
            
            input.click();
        }

        function showSyncStatus(status) {
            const statusMap = {
                'success': '‚òÅÔ∏è Gesynchroniseerd',
                'error': '‚ö†Ô∏è Sync mislukt',
                'loaded': 'üì• Geladen van cloud',
                'onedrive-active': 'üìÅ OneDrive actief',
                'onedrive-loaded': 'üìÅ Geladen van OneDrive',
                'onedrive-saved': 'üìÅ Opgeslagen in OneDrive',
                'onedrive-imported': 'üìÅ Ge√Ømporteerd van OneDrive'
            };
            
            // Create or update status indicator
            let indicator = document.getElementById('syncStatusIndicator');
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.id = 'syncStatusIndicator';
                indicator.style.cssText = `
                    position: fixed;
                    bottom: 2rem;
                    right: 2rem;
                    padding: 0.75rem 1rem;
                    background: var(--dark-card);
                    border: 1px solid var(--border);
                    border-radius: 8px;
                    font-size: 0.875rem;
                    z-index: 10000;
                    opacity: 0;
                    transition: opacity 0.3s ease;
                `;
                document.body.appendChild(indicator);
            }
            
            indicator.textContent = statusMap[status] || status;
            indicator.style.opacity = '1';
            
            // Fade out after 3 seconds
            setTimeout(() => {
                indicator.style.opacity = '0';
            }, 3000);
        }

        // Initialize date inputs
        function initializeDateInputs() {
            // Default to full 2-year range for each employee
            document.getElementById('startDate').valueAsDate = PLANNING_START;
            document.getElementById('endDate').valueAsDate = PLANNING_END;
        }

        // Update leave employee select
        function updateLeaveEmployeeSelect() {
            const select = document.getElementById('leaveEmployee');
            select.innerHTML = '<option value="">-- Selecteer werknemer --</option>' +
                employees.map(e => `<option value="${e.id}">${e.name}</option>`).join('');
        }

        // Update stats
        function updateStats() {
            document.getElementById('statTotalEmployees').textContent = employees.length;
            
            const plannedDays = leaves.length;
            document.getElementById('statPlannedDays').textContent = plannedDays;

            // Calculate average occupancy
            const weeks = getWeeksInRange(PLANNING_START, PLANNING_END);
            let totalOccupancy = 0;
            let lowWeekCount = 0;

            weeks.forEach(week => {
                const occupancy = calculateWeekOccupancy(week.start, week.end);
                totalOccupancy += occupancy;
                if (occupancy < OCCUPANCY_THRESHOLD) {
                    lowWeekCount++;
                }
            });

            const avgOccupancy = weeks.length > 0 ? Math.round((totalOccupancy / weeks.length) * 100) : 0;
            document.getElementById('statAverageOccupancy').textContent = avgOccupancy + '%';
            document.getElementById('statLowWeeks').textContent = lowWeekCount;
        }

        // Get weeks in range
        function getWeeksInRange(start, end) {
            const weeks = [];
            let current = new Date(start);

            while (current <= end) {
                const weekStart = new Date(current);
                weekStart.setDate(weekStart.getDate() - weekStart.getDay() + (weekStart.getDay() === 0 ? -6 : 1));
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 4);

                weeks.push({ start: weekStart, end: weekEnd });
                current.setDate(current.getDate() + 7);
            }

            return weeks;
        }

        // Calculate week occupancy
        function calculateWeekOccupancy(weekStart, weekEnd) {
            if (employees.length === 0) return 100;

            let totalPresent = 0;
            let totalDays = 0;

            // Count working days (Monday-Friday)
            for (let d = new Date(weekStart); d <= weekEnd; d.setDate(d.getDate() + 1)) {
                if (d.getDay() >= 1 && d.getDay() <= 5) { // Monday to Friday
                    totalDays++;
                }
            }

            employees.forEach(emp => {
                const empLeaves = leaves.filter(l => l.employeeId === emp.id);
                
                for (let d = new Date(weekStart); d <= weekEnd; d.setDate(d.getDate() + 1)) {
                    if (d.getDay() >= 1 && d.getDay() <= 5) {
                        const dateStr = d.toISOString().split('T')[0];
                        const hasLeave = empLeaves.some(l => {
                            const start = new Date(l.startDate);
                            const end = new Date(l.endDate);
                            const startStr = start.toISOString().split('T')[0];
                            const endStr = end.toISOString().split('T')[0];
                            return dateStr >= startStr && dateStr <= endStr;
                        });

                        if (!hasLeave) {
                            totalPresent++;
                        }
                    }
                }
            });

            return totalDays > 0 ? totalPresent / (employees.length * totalDays) : 1;
        }

        // Switch view
        function switchView(view) {
            currentView = view;
            document.querySelectorAll('.view-btn').forEach((btn, idx) => {
                btn.classList.toggle('active', 
                    (idx === 0 && view === 'month') ||
                    (idx === 1 && view === 'week') ||
                    (idx === 2 && view === 'custom')
                );
            });

            const today = new Date();
            
            if (view === 'month') {
                // Show current month
                const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                document.getElementById('startDate').valueAsDate = startOfMonth;
                document.getElementById('endDate').valueAsDate = endOfMonth;
            } else if (view === 'week') {
                // Show current week (Monday to Sunday)
                const dayOfWeek = today.getDay();
                const monday = new Date(today);
                monday.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
                const sunday = new Date(monday);
                sunday.setDate(monday.getDate() + 6);
                document.getElementById('startDate').valueAsDate = monday;
                document.getElementById('endDate').valueAsDate = sunday;
            } else {
                // Custom - keep current values or reset to full range
                if (!document.getElementById('startDate').value) {
                    document.getElementById('startDate').valueAsDate = PLANNING_START;
                    document.getElementById('endDate').valueAsDate = PLANNING_END;
                }
            }
            
            updateView();
        }

        // Update view
        function updateView() {
            const startDate = document.getElementById('startDate').valueAsDate;
            const endDate = document.getElementById('endDate').valueAsDate;

            if (!startDate || !endDate) return;

            renderPlanning(startDate, endDate);
            renderAlerts(startDate, endDate);
        }

        // Render alerts
        function renderAlerts(start, end) {
            const alertsContainer = document.getElementById('alertsContainer');
            const weeks = getWeeksInRange(start, end);
            const lowOccupancyWeeks = [];

            weeks.forEach(week => {
                const occupancy = calculateWeekOccupancy(week.start, week.end);
                if (occupancy < OCCUPANCY_THRESHOLD) {
                    lowOccupancyWeeks.push({
                        week: week,
                        occupancy: Math.round(occupancy * 100)
                    });
                }
            });

            if (lowOccupancyWeeks.length === 0) {
                alertsContainer.innerHTML = '';
                return;
            }

            alertsContainer.innerHTML = lowOccupancyWeeks.map(item => `
                <div class="alert">
                    <div class="alert-icon">‚ö†Ô∏è</div>
                    <div class="alert-content">
                        <h3>Lage Bezetting Gedetecteerd</h3>
                        <p>Week ${item.week.start.toLocaleDateString('nl-NL')} - ${item.week.end.toLocaleDateString('nl-NL')}: ${item.occupancy}% (onder 70%)</p>
                    </div>
                </div>
            `).join('');
        }

        // Render planning
        function renderPlanning(start, end) {
            const grid = document.getElementById('planningGrid');

            // Filter employees by selected project
            const filteredEmployees = selectedProject === 'all' 
                ? employees 
                : employees.filter(e => {
                    const empProjects = Array.isArray(e.projects) ? e.projects : [e.project].filter(Boolean);
                    return empProjects.includes(selectedProject);
                });

            if (filteredEmployees.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üë•</div>
                        <h3>Geen werknemers gevonden</h3>
                        <p>${selectedProject === 'all' ? 'Voeg werknemers toe om de planning te zien.' : 'Geen werknemers in dit project.'}</p>
                    </div>
                `;
                return;
            }

            // Generate date range
            const dates = [];
            const startDate = new Date(start);
            const endDate = new Date(end);
            
            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                dates.push(new Date(d));
            }

            // Get week number
            function getWeekNumber(date) {
                const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
                const dayNum = d.getUTCDay() || 7;
                d.setUTCDate(d.getUTCDate() + 4 - dayNum);
                const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
                return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            }

            // Header row with dates
            let html = `
                <div class="planning-row">
                    <div class="planning-header">Werknemer</div>
                    <div class="planning-cells">
                        ${dates.map((date, idx) => {
                            const day = date.toLocaleDateString('nl-NL', { weekday: 'short', day: 'numeric', month: 'short' });
                            const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                            const isMonday = date.getDay() === 1;
                            const weekNum = isMonday ? `<div class="week-number">W${getWeekNumber(date)}</div>` : '';
                            return `
                                ${weekNum}
                                <div class="planning-header ${isWeekend ? 'weekend' : ''}">${day}</div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;

            // Employee rows
            filteredEmployees.forEach(emp => {
                const empLeaves = leaves.filter(l => l.employeeId === emp.id);
                
                html += `
                    <div class="planning-row">
                        <div style="font-weight: 600; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div>${emp.name}</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">${Array.isArray(emp.projects) ? emp.projects.join(', ') : (emp.project || '')}</div>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button onclick="editEmployee('${emp.id}')" style="background: none; border: none; color: var(--primary); cursor: pointer; font-size: 1rem;" title="Bewerken">‚úèÔ∏è</button>
                                <button onclick="deleteEmployee('${emp.id}')" style="background: none; border: none; color: var(--danger); cursor: pointer; font-size: 1rem;" title="Verwijderen">üóëÔ∏è</button>
                            </div>
                        </div>
                        <div class="planning-cells">
                            ${dates.map((date, idx) => {
                                const dateStr = date.toISOString().split('T')[0];
                                const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                                const isMonday = date.getDay() === 1;
                                
                                const leave = empLeaves.find(l => {
                                    const leaveStart = new Date(l.startDate);
                                    const leaveEnd = new Date(l.endDate);
                                    return dateStr >= leaveStart.toISOString().split('T')[0] && dateStr <= leaveEnd.toISOString().split('T')[0];
                                });

                                let cellClass = 'planning-cell present';
                                let cellText = '‚úì';
                                let clickAction = `openLeaveModal('${emp.id}', '${dateStr}')`;
                                let title = 'Aanwezig - Klik om verlof toe te voegen';

                                if (leave) {
                                    cellClass = `planning-cell ${leave.type}`;
                                    const typeEmojis = { vacation: 'üèñÔ∏è', sick: 'ü§í', parttime: '‚è±Ô∏è' };
                                    cellText = typeEmojis[leave.type] || leave.type[0].toUpperCase();
                                    clickAction = `openEditDayModal('${leave.id}', '${emp.id}', '${emp.name}', '${dateStr}', '${leave.type}')`;
                                    title = `${leave.type} - Klik om aan te passen`;
                                }

                                if (isWeekend) {
                                    cellClass += ' weekend';
                                }

                                const weekNumCell = isMonday ? '<div class="week-number"></div>' : '';

                                return `
                                    ${weekNumCell}
                                    <div class="${cellClass}" onclick="${clickAction}" title="${title}" style="cursor: pointer;">
                                        ${cellText}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            });

            grid.innerHTML = html;
        }

        // Open add employee modal
        function openAddEmployeeModal() {
            editingEmployeeId = null;
            document.getElementById('employeeModalTitle').textContent = 'Werknemer Toevoegen';
            document.getElementById('employeeForm').reset();
            updateProjectCheckboxes();
            document.getElementById('employeeModal').classList.add('active');
        }

        // Edit employee
        function editEmployee(employeeId) {
            const employee = employees.find(e => e.id === employeeId);
            if (!employee) return;

            editingEmployeeId = employeeId;
            document.getElementById('employeeModalTitle').textContent = 'Werknemer Bewerken';
            document.getElementById('employeeName').value = employee.name;
            document.getElementById('employeeEmail').value = employee.email;
            document.getElementById('employeeRole').value = employee.role;
            
            updateProjectCheckboxes(employee.projects || [employee.project].filter(Boolean));
            document.getElementById('employeeModal').classList.add('active');
        }

        // Open leave modal
        function openLeaveModal(employeeId = null, clickedDate = null) {
            if (employeeId) {
                document.getElementById('leaveEmployee').value = employeeId;
            }
            
            // Set clicked date as default start and end date
            if (clickedDate) {
                document.getElementById('leaveStartDate').value = clickedDate;
                document.getElementById('leaveEndDate').value = clickedDate;
            }
            
            document.getElementById('leaveModal').classList.add('active');
        }

        // Close modal
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Update project checkboxes
        function updateProjectCheckboxes(selectedProjects = []) {
            const container = document.getElementById('employeeProjectsCheckboxes');
            if (container) {
                container.innerHTML = projects.map(p => `
                    <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--dark-card); border: 1px solid ${selectedProjects.includes(p) ? 'var(--primary)' : 'var(--border)'}; border-radius: 8px; cursor: pointer; transition: all 0.2s ease;">
                        <input type="checkbox" name="employeeProjects" value="${p}" 
                            ${selectedProjects.includes(p) ? 'checked' : ''}
                            style="cursor: pointer; width: 18px; height: 18px; accent-color: var(--primary);">
                        <span style="font-weight: 500;">${p}</span>
                    </label>
                `).join('');
            }
        }

        // Render project tabs
        function renderProjectTabs() {
            const projectTabs = document.getElementById('projectTabs');
            
            const projectCounts = {};
            projects.forEach(p => {
                projectCounts[p] = employees.filter(e => {
                    const empProjects = Array.isArray(e.projects) ? e.projects : [e.project].filter(Boolean);
                    return empProjects.includes(p);
                }).length;
            });
            projectCounts['all'] = employees.length;

            projectTabs.innerHTML = `
                <div class="view-btn ${selectedProject === 'all' ? 'active' : ''}" onclick="selectProject('all')" style="cursor: pointer;">
                    üåê Alle Projecten (${projectCounts['all']})
                </div>
                ${projects.map(project => `
                    <div class="view-btn ${selectedProject === project ? 'active' : ''}" onclick="selectProject('${project}')" style="cursor: pointer;">
                        ${project} (${projectCounts[project]})
                    </div>
                `).join('')}
            `;
        }

        // Select project
        function selectProject(project) {
            selectedProject = project;
            renderProjectTabs();
            updateView();
        }

        // Open project manager
        function openProjectManager() {
            const projectList = document.getElementById('projectList');
            projectList.innerHTML = `
                <div style="color: var(--text-muted); margin-bottom: 1rem; font-weight: 600;">Huidige projecten:</div>
                ${projects.map((p, idx) => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: var(--dark-card); border-radius: 8px; margin-bottom: 0.5rem;">
                        <span>üìÅ ${p}</span>
                        <button onclick="deleteProject(${idx})" style="background: var(--danger); border: none; color: white; padding: 0.35rem 0.75rem; border-radius: 6px; cursor: pointer;">üóëÔ∏è</button>
                    </div>
                `).join('')}
            `;
            document.getElementById('projectModal').classList.add('active');
            document.getElementById('newProjectName').value = '';
        }

        // Add project
        function addProject() {
            const name = document.getElementById('newProjectName').value.trim();
            if (!name) {
                alert('Voer een projectnaam in');
                return;
            }
            
            if (projects.includes(name)) {
                alert('Dit project bestaat al');
                return;
            }
            
            projects.push(name);
            saveData();
            openProjectManager();
        }

        // Delete project
        function deleteProject(idx) {
            if (confirm(`Weet je zeker dat je het project "${projects[idx]}" wilt verwijderen?`)) {
                projects.splice(idx, 1);
                saveData();
                if (selectedProject === projects[idx]) {
                    selectProject('all');
                }
                openProjectManager();
            }
        }

        // Save employee
        function saveEmployee(event) {
            event.preventDefault();

            const selectedProjects = Array.from(document.querySelectorAll('input[name="employeeProjects"]:checked'))
                .map(cb => cb.value);

            if (selectedProjects.length === 0) {
                alert('Selecteer minimaal √©√©n project');
                return;
            }

            const employee = {
                id: editingEmployeeId || Date.now().toString(),
                name: document.getElementById('employeeName').value,
                email: document.getElementById('employeeEmail').value,
                role: document.getElementById('employeeRole').value,
                projects: selectedProjects,
                createdAt: editingEmployeeId ? employees.find(e => e.id === editingEmployeeId).createdAt : new Date().toISOString()
            };

            if (editingEmployeeId) {
                const idx = employees.findIndex(e => e.id === editingEmployeeId);
                employees[idx] = { ...employees[idx], ...employee };
            } else {
                employees.push(employee);
            }

            saveData();
            closeModal('employeeModal');
            updateView();
        }

        // Toggle weekday selector
        function toggleWeekdaySelector() {
            const isChecked = document.getElementById('applyWeekdays').checked;
            document.getElementById('weekdaySelector').style.display = isChecked ? 'block' : 'none';
            
            // Change type to parttime when weekdays are selected
            if (isChecked) {
                document.getElementById('leaveType').value = 'parttime';
            }
        }

        // Save leave
        function saveLeave(event) {
            event.preventDefault();

            const employeeId = document.getElementById('leaveEmployee').value;
            const startDate = document.getElementById('leaveStartDate').value;
            const endDate = document.getElementById('leaveEndDate').value;
            const type = document.getElementById('leaveType').value;
            const note = document.getElementById('leaveNote').value;
            const applyWeekdays = document.getElementById('applyWeekdays').checked;

            if (new Date(endDate) < new Date(startDate)) {
                alert('Einddatum moet na startdatum zijn!');
                return;
            }

            if (applyWeekdays) {
                // Get selected weekdays
                const selectedDays = Array.from(document.querySelectorAll('.weekday-checkbox:checked'))
                    .map(cb => parseInt(cb.value));
                
                if (selectedDays.length === 0) {
                    alert('Selecteer minimaal √©√©n weekdag!');
                    return;
                }

                const dayNames = ['Zondag', 'Maandag', 'Dinsdag', 'Woensdag', 'Donderdag', 'Vrijdag', 'Zaterdag'];
                
                // Create leave entries for all selected weekdays in the range
                const start = new Date(startDate);
                const end = new Date(endDate);
                
                for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                    if (selectedDays.includes(d.getDay())) {
                        const dayStr = d.toISOString().split('T')[0];
                        leaves.push({
                            id: Date.now().toString() + '_' + dayStr + '_' + Math.random(),
                            employeeId: employeeId,
                            startDate: dayStr,
                            endDate: dayStr,
                            type: type,
                            note: note ? note + ' (' + dayNames[d.getDay()] + ')' : dayNames[d.getDay()]
                        });
                    }
                }
            } else {
                // Regular single leave entry
                const leave = {
                    id: Date.now().toString(),
                    employeeId: employeeId,
                    startDate: startDate,
                    endDate: endDate,
                    type: type,
                    note: note
                };
                leaves.push(leave);
            }

            saveData();
            closeModal('leaveModal');
            document.getElementById('leaveForm').reset();
            document.getElementById('weekdaySelector').style.display = 'none';
            document.getElementById('applyWeekdays').checked = false;
            document.querySelectorAll('.weekday-checkbox').forEach(cb => cb.checked = false);
            updateView();
        }

        // Delete employee
        function deleteEmployee(id) {
            if (confirm('Weet je zeker dat je deze werknemer wilt verwijderen?')) {
                employees = employees.filter(e => e.id !== id);
                leaves = leaves.filter(l => l.employeeId !== id);
                saveData();
                updateView();
            }
        }

        // Edit day modal - stores current context
        let editDayContext = {
            leaveId: null,
            employeeId: null,
            employeeName: null,
            dateStr: null,
            currentType: null
        };

        // Open edit day modal
        function openEditDayModal(leaveId, employeeId, employeeName, dateStr, currentType) {
            editDayContext = { leaveId, employeeId, employeeName, dateStr, currentType };
            
            const date = new Date(dateStr);
            const formattedDate = date.toLocaleDateString('nl-NL', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            
            document.getElementById('editDayEmployee').textContent = employeeName;
            document.getElementById('editDayDate').textContent = formattedDate;
            
            const statusMap = {
                'vacation': 'üèñÔ∏è Vakantie',
                'sick': 'ü§í Ziek',
                'parttime': '‚è±Ô∏è Parttime'
            };
            document.getElementById('editDayCurrentStatus').textContent = `Huidige status: ${statusMap[currentType]}`;
            
            document.getElementById('editDayModal').classList.add('active');
        }

        // Change day status
        function changeDayStatus(newStatus) {
            const { leaveId, employeeId, dateStr, currentType } = editDayContext;
            
            if (newStatus === 'work') {
                // Remove leave for this day
                removeLeaveDay(leaveId, dateStr);
            } else if (newStatus !== currentType) {
                // Change leave type for this day
                changeLeaveType(leaveId, dateStr, newStatus, employeeId);
            }
            
            closeModal('editDayModal');
        }

        // Change leave type for specific day
        function changeLeaveType(leaveId, dateStr, newType, employeeId) {
            const leaveIndex = leaves.findIndex(l => l.id === leaveId);
            if (leaveIndex === -1) return;

            const leave = leaves[leaveIndex];
            const targetDate = dateStr;
            const leaveStart = leave.startDate;
            const leaveEnd = leave.endDate;

            // If leave is only one day, just change the type
            if (leaveStart === leaveEnd && leaveStart === targetDate) {
                leaves[leaveIndex].type = newType;
            }
            // If it's the first day, split and change
            else if (leaveStart === targetDate) {
                const dayAfter = new Date(leaveStart);
                dayAfter.setDate(dayAfter.getDate() + 1);
                
                // Move existing leave forward
                leaves[leaveIndex].startDate = dayAfter.toISOString().split('T')[0];
                
                // Create new single-day leave with new type
                leaves.push({
                    id: Date.now().toString(),
                    employeeId: employeeId,
                    startDate: targetDate,
                    endDate: targetDate,
                    type: newType,
                    note: ''
                });
            }
            // If it's the last day
            else if (leaveEnd === targetDate) {
                const dayBefore = new Date(leaveEnd);
                dayBefore.setDate(dayBefore.getDate() - 1);
                
                // Shorten existing leave
                leaves[leaveIndex].endDate = dayBefore.toISOString().split('T')[0];
                
                // Create new single-day leave with new type
                leaves.push({
                    id: Date.now().toString(),
                    employeeId: employeeId,
                    startDate: targetDate,
                    endDate: targetDate,
                    type: newType,
                    note: ''
                });
            }
            // If it's in the middle, split into three periods
            else {
                const dayBefore = new Date(targetDate);
                dayBefore.setDate(dayBefore.getDate() - 1);
                const dayAfter = new Date(targetDate);
                dayAfter.setDate(dayAfter.getDate() + 1);

                // Shorten existing leave to end day before
                leaves[leaveIndex].endDate = dayBefore.toISOString().split('T')[0];

                // Create new leave for target day with new type
                leaves.push({
                    id: Date.now().toString(),
                    employeeId: employeeId,
                    startDate: targetDate,
                    endDate: targetDate,
                    type: newType,
                    note: ''
                });

                // Create new leave for days after
                leaves.push({
                    id: (Date.now() + 1).toString(),
                    employeeId: employeeId,
                    startDate: dayAfter.toISOString().split('T')[0],
                    endDate: leaveEnd,
                    type: leave.type,
                    note: leave.note
                });
            }

            saveData();
            updateView();
            showSyncStatus('onedrive-saved');
        }

        // Remove leave for specific day
        function removeLeaveDay(leaveId, dateStr) {
            const leaveIndex = leaves.findIndex(l => l.id === leaveId);
            if (leaveIndex === -1) return;

            const leave = leaves[leaveIndex];
            const targetDate = dateStr;
            const leaveStart = leave.startDate;
            const leaveEnd = leave.endDate;

            // If leave is only one day, delete entire leave entry
            if (leaveStart === leaveEnd && leaveStart === targetDate) {
                leaves.splice(leaveIndex, 1);
            }
            // If it's the first day of multi-day leave, move start date forward
            else if (leaveStart === targetDate) {
                const newStart = new Date(leaveStart);
                newStart.setDate(newStart.getDate() + 1);
                leaves[leaveIndex].startDate = newStart.toISOString().split('T')[0];
            }
            // If it's the last day, move end date backward
            else if (leaveEnd === targetDate) {
                const newEnd = new Date(leaveEnd);
                newEnd.setDate(newEnd.getDate() - 1);
                leaves[leaveIndex].endDate = newEnd.toISOString().split('T')[0];
            }
            // If it's in the middle, split into two leave periods
            else {
                const dayBefore = new Date(targetDate);
                dayBefore.setDate(dayBefore.getDate() - 1);
                const dayAfter = new Date(targetDate);
                dayAfter.setDate(dayAfter.getDate() + 1);

                // Shorten existing leave to end day before
                leaves[leaveIndex].endDate = dayBefore.toISOString().split('T')[0];

                // Create new leave for days after
                const newLeave = {
                    id: Date.now().toString(),
                    employeeId: leave.employeeId,
                    startDate: dayAfter.toISOString().split('T')[0],
                    endDate: leaveEnd,
                    type: leave.type,
                    note: leave.note
                };
                leaves.push(newLeave);
            }

            saveData();
            updateView();
            showSyncStatus('onedrive-saved');
        }

        // Cloud Sync UI Functions
        function toggleCloudSync() {
            document.getElementById('cloudSyncModal').classList.add('active');
            updateCloudSyncUI();
        }

        function updateCloudSyncUI() {
            const enabledCheckbox = document.getElementById('cloudSyncEnabled');
            const apiKeyInput = document.getElementById('cloudApiKey');
            const statusText = document.getElementById('cloudSyncStatus');
            const syncBtn = document.getElementById('cloudSyncBtn');
            const syncIcon = document.getElementById('cloudSyncIcon');
            const syncText = document.getElementById('cloudSyncText');

            enabledCheckbox.checked = CLOUD_CONFIG.enabled;
            apiKeyInput.value = CLOUD_CONFIG.apiKey;

            if (CLOUD_CONFIG.enabled && CLOUD_CONFIG.binId) {
                statusText.innerHTML = `‚úÖ Actief - Bin ID: <code>${CLOUD_CONFIG.binId.substring(0, 12)}...</code>`;
                syncBtn.style.background = 'var(--success)';
                syncIcon.textContent = '‚òÅÔ∏è';
            } else if (CLOUD_CONFIG.enabled && !CLOUD_CONFIG.apiKey) {
                statusText.textContent = '‚ö†Ô∏è API key vereist';
                syncBtn.style.background = 'var(--warning)';
                syncIcon.textContent = '‚ö†Ô∏è';
            } else if (!CLOUD_CONFIG.enabled) {
                statusText.textContent = '‚≠ï Uitgeschakeld - Data wordt alleen lokaal opgeslagen';
                syncBtn.style.background = 'var(--dark-lighter)';
                syncIcon.textContent = '‚òÅÔ∏è';
            }
        }

        function updateCloudSyncSettings() {
            CLOUD_CONFIG.enabled = document.getElementById('cloudSyncEnabled').checked;
            CLOUD_CONFIG.apiKey = document.getElementById('cloudApiKey').value;

            localStorage.setItem('cloud_sync_enabled', CLOUD_CONFIG.enabled);
            localStorage.setItem('cloud_api_key', CLOUD_CONFIG.apiKey);

            updateCloudSyncUI();

            if (CLOUD_CONFIG.enabled) {
                startAutoSync();
            } else {
                if (syncTimer) clearInterval(syncTimer);
            }
        }

        function manualSync() {
            syncToCloud();
            setTimeout(() => {
                updateCloudSyncUI();
            }, 1000);
        }

        // Load cloud settings on init
        function loadCloudSettings() {
            const savedEnabled = localStorage.getItem('cloud_sync_enabled');
            const savedApiKey = localStorage.getItem('cloud_api_key');
            
            if (savedEnabled !== null) {
                CLOUD_CONFIG.enabled = savedEnabled === 'true';
            }
            if (savedApiKey) {
                CLOUD_CONFIG.apiKey = savedApiKey;
            }
        }

        // Export planning
        function exportPlanning() {
            const startDate = document.getElementById('startDate').valueAsDate;
            const endDate = document.getElementById('endDate').valueAsDate;

            let csv = 'Werknemer,Datum,Status\n';

            const dates = [];
            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                dates.push(new Date(d).toISOString().split('T')[0]);
            }

            employees.forEach(emp => {
                const empLeaves = leaves.filter(l => l.employeeId === emp.id);
                
                dates.forEach(dateStr => {
                    const leave = empLeaves.find(l => 
                        dateStr >= l.startDate && dateStr <= l.endDate
                    );
                    csv += `"${emp.name}","${dateStr}","${leave ? leave.type : 'present'}"\n`;
                });
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `werknemerplanning-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
