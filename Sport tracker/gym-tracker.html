<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Gym Tracker">
    <meta name="theme-color" content="#000000">
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiR3ltIFRyYWNrZXIiLCJzaG9ydF9uYW1lIjoiR3ltIiwic3RhcnRfdXJsIjoiLiIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiMwMDAwMDAiLCJ0aGVtZV9jb2xvciI6IiMzNEM3NTkifQ==">
    <title> Gym Tracker Pro</title>
</head>
<body>
<!-- Console Log Overlay -->
<div id="console-log-overlay" style="display:none;position:fixed;bottom:0;left:0;right:0;max-height:40vh;overflow-y:auto;z-index:99999;background:rgba(0,0,0,0.92);color:#fff;font-size:13px;font-family:monospace;padding:8px 12px;border-top:2px solid #34C759;box-shadow:0 -2px 16px #000;pointer-events:auto;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
        <b>Console Log</b>
        <button onclick="document.getElementById('console-log-overlay').style.display='none'" style="background:#222;color:#fff;border:none;padding:2px 10px;border-radius:6px;">Sluiten</button>
    </div>
    <div id="console-log-content"></div>
</div>
<button id="showConsoleLogBtn" onclick="document.getElementById('console-log-overlay').style.display='block'" style="position:fixed;bottom:12px;right:12px;z-index:99999;background:#34C759;color:#000;font-weight:bold;border:none;padding:8px 14px;border-radius:20px;box-shadow:0 2px 8px #000;display:none;">Log</button>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
}

:root {
    --primary: #34C759;
    --secondary: #FF9500;
    --tertiary: #5AC8FA;
    --danger: #FF3B30;
    --warning: #FFCC00;
    --purple: #AF52DE;
    --dark: #000000;
    --dark-lighter: #1C1C1E;
    --dark-card: #2C2C2E;
    --dark-elevated: #3A3A3C;
    --text: #FFFFFF;
    --text-muted: #8E8E93;
    --border: #38383A;
    --success: #34C759;
    --gold: linear-gradient(135deg, #FFD700, #FFA500);
    --shadow: 0 10px 40px rgba(0,0,0,0.3);
    --schema-accent: var(--primary);
    --schema-accent-2: var(--secondary);
}

/* Light Mode Colors */
body.light-mode {
    --dark: #FFFFFF;
    --dark-lighter: #F5F5F7;
    --dark-card: #FFFFFF;
    --dark-elevated: #F9F9FB;
    --text: #000000;
    --text-muted: #6B6B6F;
    --border: #D5D5D7;
    --shadow: 0 10px 40px rgba(0,0,0,0.1);
}

body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    background: var(--dark);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
    -webkit-font-smoothing: antialiased;
    position: relative;
    padding-bottom: 100px;
}

/* iOS Safari standalone viewport fixes */
html { height: -webkit-fill-available; }
body { min-height: -webkit-fill-available; }

/* Prevent white flashes during load and show boot errors */
#boot-error-overlay {
    position: fixed;
    inset: 0;
    background: #000000;
    color: #FF3B30;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 24px;
    z-index: 9999;
}
#boot-error-overlay .content { max-width: 640px; text-align: center; }

body::before {
    content: "";
    position: fixed;
    inset: 0;
    background: radial-gradient(circle at 20% 50%, rgba(52, 199, 89, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 149, 0, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 50% 20%, rgba(175, 82, 222, 0.05) 0%, transparent 50%);
    pointer-events: none;
    z-index: 0;
    animation: bgMove 20s ease-in-out infinite;
}

@keyframes bgMove {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

.container {
    max-width: 100%;
    margin: 0 auto;
    padding: 1rem;
    position: relative;
    z-index: 1;
}

@media (min-width: 768px) {
    .container {
        max-width: 768px;
    }
}

/* Header Styles */
.header {
    position: sticky;
    top: 0;
    background: rgba(0, 0, 0, 0.95);
    backdrop-filter: blur(30px) saturate(180%);
    z-index: 100;
    padding: 1rem;
    border-bottom: 1px solid var(--border);
    margin: -1rem -1rem 1.5rem -1rem;
}

.header-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

h1 {
    font-size: 2rem;
    font-weight: 800;
    background: var(--gold);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    letter-spacing: -0.5px;
}

.icon-group {
    display: flex;
    gap: 0.5rem;
}

.icon-btn {
    background: var(--dark-card);
    border: 1px solid var(--border);
    color: var(--text);
    width: 44px;
    height: 44px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.icon-btn::before {
    content: "";
    position: absolute;
    inset: 0;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
    opacity: 0;
    transition: opacity 0.3s;
}

.icon-btn:active {
    transform: scale(0.92);
}

.icon-btn:active::before {
    opacity: 1;
}

.header-tabs {
    display: flex;
    gap: 0.5rem;
    overflow-x: auto;
    scrollbar-width: none;
    -ms-overflow-style: none;
}

.header-tabs::-webkit-scrollbar {
    display: none;
}

.tab {
    padding: 0.5rem 0.875rem;
    border-radius: 20px;
    background: var(--dark-card);
    color: var(--text-muted);
    border: 1px solid var(--border);
    cursor: pointer;
    white-space: nowrap;
    font-weight: 600;
    font-size: 0.8rem;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.tab::before {
    content: "";
    position: absolute;
    inset: 0;
    background: var(--primary);
    opacity: 0;
    transition: opacity 0.3s;
}

.tab.active {
    background: var(--primary);
    color: var(--dark);
    border-color: var(--primary);
    box-shadow: 0 4px 12px rgba(52, 199, 89, 0.4);
}

.tab:not(.active):active {
    transform: scale(0.95);
}

/* View Management */
.view {
    display: none;
}

.view.active {
    display: block;
    animation: fadeSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    background: radial-gradient(circle at 20% 30%, rgba(255,255,255,0.03), transparent 40%),
                radial-gradient(circle at 80% 20%, rgba(255,255,255,0.02), transparent 35%),
                radial-gradient(circle at 50% 80%, rgba(255,255,255,0.02), transparent 45%),
                repeating-linear-gradient(45deg, rgba(255,255,255,0.04), rgba(255,255,255,0.04) 6px, rgba(0,0,0,0.02) 6px, rgba(0,0,0,0.02) 12px);
}

@keyframes fadeSlideIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Schema Selection */
.schema-grid {
    display: grid;
    gap: 1rem;
    margin-bottom: 2rem;
}

.schema-card {
    --schema-accent: var(--primary);
    --schema-accent-2: var(--secondary);
    background: linear-gradient(135deg, var(--dark-card) 0%, var(--dark-elevated) 100%);
    border-radius: 24px;
    padding: 1.75rem;
    border: 2px solid var(--schema-accent);
    cursor: pointer;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.schema-card::before {
    content: "";
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, var(--schema-accent) 0%, var(--schema-accent-2) 100%);
    opacity: 0;
    transition: opacity 0.4s;
}

.schema-card:active {
    transform: scale(0.97) translateY(2px);
}

.schema-card.push {
    --schema-accent: #34C759;
    --schema-accent-2: #30B050;
}

.schema-card.legs {
    --schema-accent: #FF9500;
    --schema-accent-2: #FF8000;
}

.schema-card:hover::before {
    opacity: 0.08;
}

.schema-content {
    position: relative;
    z-index: 1;
}

.schema-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
}

.schema-icon {
    font-size: 3rem;
    filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
}

.schema-badge {
    background: var(--schema-accent);
    color: var(--dark);
    padding: 0.375rem 0.875rem;
    border-radius: 14px;
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.schema-card h3 {
    font-size: 1.75rem;
    margin-bottom: 0.5rem;
    font-weight: 700;
}

.schema-card p {
    color: var(--text-muted);
    font-size: 1rem;
    line-height: 1.5;
}

.schema-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
    margin-top: 1.25rem;
    padding-top: 1.25rem;
    border-top: 1px solid var(--border);
}

.schema-stat {
    text-align: center;
}

.schema-stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--schema-accent);
    display: block;
    margin-bottom: 0.25rem;
}

.schema-stat-label {
    font-size: 0.8rem;
    color: var(--text-muted);
}

/* Timer Card */
.timer-card {
    --schema-accent: var(--primary);
    --schema-accent-2: var(--secondary);
    background: linear-gradient(135deg, var(--dark-card) 0%, var(--dark-elevated) 100%);
    border-radius: 24px;
    padding: 2rem;
    text-align: center;
    margin-bottom: 1.5rem;
    border: 1px solid var(--schema-accent);
    position: relative;
    overflow: hidden;
    box-shadow: var(--shadow);
}

.timer-card::before {
    content: "";
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: conic-gradient(from 0deg, transparent 0%, var(--schema-accent) 50%, transparent 100%);
    animation: timerRotate 6s linear infinite;
    opacity: 0;
    transition: opacity 0.5s;
}

.timer-card.running::before {
    opacity: 0.15;
}

@keyframes timerRotate {
    100% { transform: rotate(360deg); }
}

.timer-content {
    position: relative;
    z-index: 1;
}

.timer-label {
    color: var(--text-muted);
    font-size: 0.95rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 0.75rem;
}

.timer-meta {
    color: var(--text-muted);
    font-size: 0.9rem;
    margin-top: 0.25rem;
}

.timer-inline-stats {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.75rem;
    margin-top: 0.75rem;
}

.timer-stat {
    background: var(--dark-elevated);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 0.65rem 0.85rem;
    text-align: center;
}

.timer-stat-label {
    display: block;
    color: var(--text-muted);
    font-size: 0.8rem;
    margin-bottom: 0.15rem;
    font-weight: 600;
}

.timer-stat-value {
    display: block;
    font-size: 1.25rem;
    font-weight: 800;
}

.timer {
    font-size: 4rem;
    font-weight: 800;
    font-variant-numeric: tabular-nums;
    margin: 1rem 0;
    background: var(--gold);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    letter-spacing: -2px;
}

.timer-controls {
    display: flex;
    gap: 1rem;
    justify-content: center;
    margin-top: 1.5rem;
}

/* Buttons */
.btn {
    padding: 1rem 1.75rem;
    border-radius: 16px;
    border: none;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    font-size: 1rem;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    position: relative;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.btn::before {
    content: "";
    position: absolute;
    inset: 0;
    background: rgba(255, 255, 255, 0.15);
    opacity: 0;
    transition: opacity 0.2s;
}

.btn:active {
    transform: scale(0.96) translateY(1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.btn:active::before {
    opacity: 1;
}

.btn-primary {
    background: linear-gradient(135deg, #34C759 0%, #30B050 100%);
    color: var(--dark);
}

.btn-secondary {
    background: var(--dark-elevated);
    color: var(--text);
    border: 1px solid var(--border);
}

.btn-danger {
    background: linear-gradient(135deg, #FF3B30 0%, #D63028 100%);
    color: var(--text);
}

.btn-warning {
    background: linear-gradient(135deg, #FFCC00 0%, #FFB800 100%);
    color: var(--dark);
}

.btn-icon {
    width: 48px;
    height: 48px;
    padding: 0;
    border-radius: 50%;
}

.btn-icon.delete-btn {
    background: transparent;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    padding: 0.35rem;
    border-radius: 8px;
    width: auto;
    height: auto;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.btn-icon.delete-btn:hover {
    background: var(--dark-elevated);
    color: #FF3B30;
}

.btn-icon.delete-btn:active {
    transform: scale(0.95);
}

/* Stats Card */
.stats-card {
    background: linear-gradient(135deg, var(--dark-card) 0%, var(--dark-elevated) 100%);
    border-radius: 24px;
    padding: 1.75rem;
    margin-bottom: 1.5rem;
    border: 1px solid var(--border);
    box-shadow: var(--shadow);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1.5rem;
}

.stat-item {
    text-align: center;
    position: relative;
}

.stat-item::before {
    content: "";
    position: absolute;
    top: 50%;
    right: 0;
    width: 1px;
    height: 60%;
    background: var(--border);
    transform: translateY(-50%);
}

.stat-item:last-child::before {
    display: none;
}

.stat-value {
    font-size: 2.25rem;
    font-weight: 800;
    background: var(--gold);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    display: block;
    margin-bottom: 0.5rem;
    letter-spacing: -1px;
}

.stat-label {
    font-size: 0.875rem;
    color: var(--text-muted);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Rest Timer */
.rest-timer-card {
    background: var(--dark-card);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 1rem;
    margin-bottom: 1rem;
    display: none;
    box-shadow: var(--shadow);
}

.rest-timer-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
    gap: 0.75rem;
}

.rest-timer-title {
    font-weight: 700;
    color: var(--text);
}

.rest-timer-actions {
    display: flex;
    gap: 0.5rem;
}

.rest-timer-progress {
    position: relative;
    width: 100%;
    height: 10px;
    background: var(--dark-elevated);
    border-radius: 999px;
    overflow: hidden;
    border: 1px solid var(--border);
}

.rest-timer-progress > div {
    height: 100%;
    width: 100%;
    background: linear-gradient(90deg, var(--primary), #2FAA4E);
    transition: width 0.25s ease;
}

/* Muscle Groups */
.muscle-group {
    margin-bottom: 2rem;
}

.muscle-group-header {
    background: var(--dark-card);
    padding: 1.25rem 1.5rem;
    border-radius: 20px;
    margin-bottom: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: 1px solid var(--border);
    box-shadow: var(--shadow);
}

.muscle-group-title {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.muscle-group-icon {
    font-size: 1.5rem;
}

.muscle-group-header h3 {
    font-size: 1.35rem;
    font-weight: 700;
}

.progress-badge {
    background: var(--dark-elevated);
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
    border: 1px solid var(--border);
}

/* Exercise Cards */
.exercise-card {
    background: var(--dark-elevated);
    border-radius: 20px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    border: 1px solid var(--border);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.exercise-card:active {
    transform: scale(0.99);
}

.exercise-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1.25rem;
}

.exercise-title {
    flex: 1;
}

.exercise-name {
    font-size: 1.2rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.pr-badge-inline {
    background: linear-gradient(135deg, #FFD700, #FFA500);
    color: var(--dark);
    padding: 0.25rem 0.625rem;
    border-radius: 10px;
    font-size: 0.7rem;
    font-weight: 800;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    animation: prGlow 2s ease-in-out infinite;
}

@keyframes prGlow {
    0%, 100% { box-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }
    50% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.8); }
}

.exercise-meta {
    color: var(--text-muted);
    font-size: 0.875rem;
    display: flex;
    gap: 1rem;
}

.exercise-meta-item {
    display: flex;
    align-items: center;
    gap: 0.375rem;
}

.exercise-actions {
    display: flex;
    gap: 0.5rem;
}

.exercise-btn {
    background: var(--dark-card);
    border: 1px solid var(--border);
    color: var(--text);
    width: 40px;
    height: 40px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
}

.exercise-btn::before {
    content: "";
    width: 16px;
    height: 16px;
    background: currentColor;
    mask-size: contain;
    mask-repeat: no-repeat;
    mask-position: center;
    transition: transform 0.2s ease;
}

.exercise-btn.collapse-btn::before {
    mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="%23000" d="M6.7 9l5.3 5.3L17.3 9z"/></svg>');
}

.exercise-btn.collapse-btn.collapsed::before {
    transform: rotate(-90deg);
}

.exercise-btn.progress-btn::before {
    mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="%23000" d="M5 18h3V8H5zm6 0h3V5h-3zm6 0h3V11h-3z"/></svg>');
}

.exercise-btn:active {
    transform: scale(0.88);
}

/* Sets Container */
.sets-container {
    display: grid;
    gap: 0.875rem;
}

.set-row {
    background: var(--dark-card);
    border-radius: 14px;
    padding: 1rem;
    display: grid;
    grid-template-columns: 1fr 1fr 50px;
    gap: 0.75rem;
    align-items: center;
    border: 2px solid transparent;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.set-row.completed {
    background: rgba(52, 199, 89, 0.15);
    border-color: var(--primary);
    box-shadow: 0 0 20px rgba(52, 199, 89, 0.2);
}

.set-row.new-pr {
    animation: prPulse 1.2s cubic-bezier(0.4, 0, 0.2, 1);
    border-color: #FFD700;
    background: linear-gradient(90deg, rgba(255, 215, 0, 0.1) 0%, transparent 100%);
}

@keyframes prPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.03); box-shadow: 0 0 30px rgba(255, 215, 0, 0.5); }
}

.set-number { display: none; }

.set-input-group {
    position: relative;
}

.set-input {
    width: 100%;
    background: var(--dark-elevated);
    border: 2px solid var(--border);
    border-radius: 12px;
    padding: 0.875rem;
    color: var(--text);
    font-size: 1.1rem;
    font-weight: 700;
    text-align: center;
    transition: all 0.2s;
    font-variant-numeric: tabular-nums;
}

.set-input:focus {
    outline: none;
    border-color: var(--primary);
    background: var(--dark-card);
    box-shadow: 0 0 0 4px rgba(52, 199, 89, 0.1);
}

.set-input-label {
    position: absolute;
    top: -9px;
    left: 14px;
    background: var(--dark-elevated);
    padding: 0 0.5rem;
    font-size: 0.75rem;
    color: var(--text-muted);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.checkbox {
    width: 36px;
    height: 36px;
    border-radius: 10px;
    border: 2px solid var(--border);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    background: var(--dark-elevated);
}

.checkbox.checked {
    background: linear-gradient(135deg, #34C759 0%, #30B050 100%);
    border-color: var(--primary);
    box-shadow: 0 4px 12px rgba(52, 199, 89, 0.4);
}

.checkbox.checked::after {
    content: "";
    color: var(--dark);
    font-weight: 900;
    font-size: 1.4rem;
}

.checkbox:active {
    transform: scale(0.85) rotate(5deg);
}

/* Previous Best */
.previous-best {
    grid-column: 1 / -1;
    padding: 0.875rem 1rem;
    background: rgba(90, 200, 250, 0.1);
    border-radius: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.875rem;
    border: 1px solid rgba(90, 200, 250, 0.2);
}

.previous-best-label {
    color: var(--tertiary);
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.previous-best-value {
    color: var(--text);
    font-weight: 700;
}

/* Calendar Styles */
.calendar-container {
    padding: 1rem 0;
}

.calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    gap: 1rem;
}

.calendar-month-year {
    font-size: 1.25rem;
    font-weight: 700;
    text-align: center;
    flex: 1;
}

.calendar-nav-btn {
    background: var(--dark-card);
    border: 1px solid var(--border);
    color: var(--text);
    width: 40px;
    height: 40px;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s;
}

.calendar-nav-btn:active {
    transform: scale(0.92);
}

.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 0.5rem;
    margin-bottom: 1.5rem;
}

.calendar-weekday {
    text-align: center;
    font-weight: 600;
    font-size: 0.85rem;
    color: var(--text-muted);
    padding: 0.5rem 0;
}

.calendar-day {
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 12px;
    border: 1px solid var(--border);
    background: var(--dark-card);
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    font-weight: 600;
    font-size: 0.95rem;
}

.calendar-day:active {
    transform: scale(0.95);
}

.calendar-day.other-month {
    color: var(--text-muted);
    opacity: 0.4;
}

.calendar-day.has-workout {
    background: var(--primary);
    color: #000;
    box-shadow: 0 0 12px rgba(52, 199, 89, 0.3);
}

.calendar-day.has-workout::after {
    content: "";
    position: absolute;
    bottom: 4px;
    width: 4px;
    height: 4px;
    background: rgba(0,0,0,0.4);
    border-radius: 50%;
}

.calendar-day.today {
    border: 2px solid var(--primary);
}

.calendar-workouts {
    background: var(--dark-card);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 1rem;
    margin-top: 1rem;
}

.calendar-workouts-title {
    font-weight: 700;
    margin-bottom: 1rem;
    color: var(--text);
}

.calendar-workout-item {
    background: var(--dark-elevated);
    padding: 0.75rem;
    border-radius: 12px;
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
}

/* Bottom Actions */
.bottom-actions {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(28, 28, 30, 0.98);
    backdrop-filter: blur(30px) saturate(180%);
    border-top: 1px solid var(--border);
    padding: 1rem;
    display: none;
    gap: 1rem;
    z-index: 999;
    box-shadow: 0 -10px 40px rgba(0,0,0,0.3);
}

.bottom-actions.active {
    display: flex;
    animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes slideUp {
    from {
        transform: translateY(100%);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.bottom-actions .btn {
    flex: 1;
    font-size: 1.05rem;
}

/* Modal */
.modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.92);
    /* backdrop-filter: blur(10px); */ /* Disabled for iOS compatibility */
    z-index: 2000;
    align-items: center;
    justify-content: center;
    padding: 1rem;
}

.modal.active {
    display: flex;
    animation: fadeIn 0.3s ease-out;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.modal-content {
    background: var(--dark-lighter);
    border-radius: 28px;
    max-width: 600px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    border: 1px solid var(--border);
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    animation: modalZoom 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes modalZoom {
    from {
        transform: scale(0.9) translateY(20px);
        opacity: 0;
    }
    to {
        transform: scale(1) translateY(0);
        opacity: 1;
    }
}

.modal-header {
    padding: 1.75rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    background: var(--dark-lighter);
    z-index: 10;
}

.modal-header h2 {
    font-size: 1.75rem;
    font-weight: 700;
}

.close-btn {
    background: var(--dark-card);
    border: 1px solid var(--border);
    color: var(--text);
    font-size: 1.75rem;
    cursor: pointer;
    width: 44px;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.2s;
    line-height: 1;
}

.close-btn:active {
    transform: scale(0.88) rotate(90deg);
}

.modal-body {
    padding: 1.75rem;
}

/* History Item */
.history-item {
    background: var(--dark-card);
    border-radius: 20px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    border: 1px solid var(--border);
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.history-item:active {
    transform: scale(0.98) translateY(1px);
}

.history-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
}

.history-date {
    font-weight: 700;
    font-size: 1.2rem;
}

.history-time {
    color: var(--text-muted);
    font-size: 0.95rem;
    margin-top: 0.25rem;
}

.history-schema {
    color: var(--primary);
    font-size: 0.95rem;
    font-weight: 700;
    padding: 0.375rem 0.875rem;
    background: rgba(52, 199, 89, 0.15);
    border-radius: 12px;
    display: inline-block;
}

.history-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
    padding-top: 1rem;
    border-top: 1px solid var(--border);
}

.history-stat {
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
}

.history-stat-value {
    font-weight: 800;
    font-size: 1.25rem;
    color: var(--text);
}

.history-stat-label {
    color: var(--text-muted);
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 3rem 1.5rem;
    color: var(--text-muted);
}

.empty-state-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

.empty-state h3 {
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
    color: var(--text);
}

.empty-state p {
    font-size: 1rem;
}

/* PR Celebration */
.pr-celebration {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.96);
    backdrop-filter: blur(20px);
    z-index: 3000;
    display: none;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.3s ease-out;
}

.pr-celebration.active {
    display: flex;
}

.pr-content {
    text-align: center;
    padding: 2.5rem;
    animation: prZoom 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes prZoom {
    0% { transform: scale(0.5) rotate(-10deg); opacity: 0; }
    70% { transform: scale(1.1) rotate(5deg); }
    100% { transform: scale(1) rotate(0deg); opacity: 1; }
}

.pr-emoji {
    font-size: 6rem;
    margin-bottom: 1.5rem;
    animation: prBounce 1s ease-in-out infinite;
    filter: drop-shadow(0 10px 30px rgba(255, 215, 0, 0.6));
}

@keyframes prBounce {
    0%, 100% { transform: translateY(0) scale(1); }
    50% { transform: translateY(-30px) scale(1.1); }
}

.pr-title {
    font-size: 3rem;
    font-weight: 900;
    background: var(--gold);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 1rem;
    text-transform: uppercase;
    letter-spacing: 2px;
}

.pr-detail {
    font-size: 1.5rem;
    color: var(--text);
    margin-bottom: 2.5rem;
    font-weight: 600;
}

.pr-sub {
    font-size: 1.1rem;
    color: var(--text-muted);
    margin-bottom: 2rem;
}

/* Floating Action Button */
.fab-add-exercise {
    position: fixed;
    bottom: 100px;
    right: 20px;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: var(--primary);
    color: white;
    border: none;
    font-size: 2rem;
    font-weight: 300;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(52, 199, 89, 0.4);
    display: none;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    z-index: 1000;
}

.fab-add-exercise.visible {
    display: flex;
}

.fab-add-exercise:hover {
    transform: scale(1.1);
    box-shadow: 0 8px 20px rgba(52, 199, 89, 0.6);
}

.fab-add-exercise:active {
    transform: scale(0.95);
}

/* Modal Styles */
.modal {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(12px);
    z-index: 2000;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 1rem;
}

.modal.active {
    display: flex;
    animation: fadeIn 0.3s ease-out;
}

.modal-content {
    background: var(--dark-card);
    border-radius: 16px;
    border: 1px solid var(--border);
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    max-height: 90vh;
    overflow-y: auto;
    animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(40px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h2 {
    margin: 0;
    font-size: 1.5rem;
}

.modal-close {
    background: none;
    border: none;
    color: var(--text);
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.modal-close:hover {
    color: var(--primary);
    transform: rotate(90deg);
}

.modal-body {
    padding: 1.5rem;
}

.modal-footer {
    padding: 1.5rem;
    border-top: 1px solid var(--border);
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-group:last-child {
    margin-bottom: 0;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    font-size: 0.95rem;
}

.form-input {
    width: 100%;
    padding: 0.75rem;
    background: var(--dark-elevated);
    border: 1px solid var(--border);
    border-radius: 10px;
    color: var(--text);
    font-size: 1rem;
    transition: all 0.2s ease;
    font-family: inherit;
}

.form-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(52, 199, 89, 0.1);
}

.form-input option {
    background: var(--dark-card);
    color: var(--text);
}

@media (max-width: 640px) {
    .fab-add-exercise {
        bottom: 80px;
        right: 16px;
    }
    
    .modal-content {
        max-width: 100%;
        border-radius: 20px 20px 0 0;
    }
}

/* Form Groups */
.form-group {
    margin-bottom: 1.75rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.875rem;
    font-weight: 700;
    color: var(--text);
    font-size: 0.95rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.form-input, .form-select {
    width: 100%;
    background: var(--dark-card);
    border: 2px solid var(--border);
    border-radius: 14px;
    padding: 1.125rem;
    color: var(--text);
    font-size: 1.05rem;
    transition: all 0.2s;
    font-weight: 600;
}

.form-input:focus, .form-select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 4px rgba(52, 199, 89, 0.1);
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 5rem 2rem;
    color: var(--text-muted);
}

.empty-state-icon {
    font-size: 5rem;
    margin-bottom: 1.5rem;
    opacity: 0.4;
    filter: grayscale(1);
}

.empty-state h3 {
    font-size: 1.5rem;
    margin-bottom: 0.75rem;
    color: var(--text);
}

.empty-state p {
    font-size: 1rem;
    line-height: 1.6;
}

/* Toast */
.toast {
    position: fixed;
    bottom: 120px;
    left: 50%;
    transform: translateX(-50%) translateY(150px);
    background: var(--dark-card);
    color: var(--text);
    padding: 1.125rem 1.75rem;
    border-radius: 16px;
    border: 1px solid var(--border);
    z-index: 2500;
    opacity: 0;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    max-width: 90%;
    font-weight: 600;
}

.toast.show {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
}

.toast.success {
    background: var(--success);
    color: var(--dark);
    border-color: var(--success);
}

.toast.error {
    background: var(--danger);
    color: var(--text);
    border-color: var(--danger);
}

/* Loading */
.loading {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 3rem;
}

.spinner {
    width: 50px;
    height: 50px;
    border: 4px solid var(--border);
    border-top-color: var(--primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    100% { transform: rotate(360deg); }
}

/* PR List */
.pr-list {
    display: grid;
    gap: 1rem;
}

.pr-card {
    background: var(--dark-card);
    border-radius: 20px;
    padding: 1.5rem;
    border: 1px solid var(--border);
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.pr-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
}

.pr-card-title {
    font-size: 1.2rem;
    font-weight: 700;
    margin-bottom: 0.375rem;
}

.pr-card-date {
    color: var(--text-muted);
    font-size: 0.85rem;
}

.pr-value {
    font-size: 2rem;
    font-weight: 800;
    background: var(--gold);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.pr-card-stats {
    display: flex;
    gap: 1.5rem;
    padding-top: 1rem;
    border-top: 1px solid var(--border);
}

.pr-card-stat {
    font-size: 0.9rem;
    color: var(--text-muted);
}

.pr-card-stat strong {
    color: var(--text);
    font-weight: 700;
}

/* Responsive */
@media (max-width: 640px) {
    h1 {
        font-size: 1.75rem;
    }
    
    .timer {
        font-size: 3rem;
    }
    
    .set-row {
        grid-template-columns: 40px 1fr 1fr 40px;
        gap: 0.75rem;
        padding: 0.875rem;
    }
    
    .stats-grid {
        gap: 1rem;
    }
    
    .stat-value {
        font-size: 1.75rem;
    }
    
    .schema-card h3 {
        font-size: 1.5rem;
    }

    /* Sets Layout */
    .sets-container {
        display: grid;
        gap: 0.75rem;
    }

    .set-row {
        display: flex;
        flex-direction: column;
        align-items: stretch;
        gap: 0.6rem;
        padding: 0.9rem;
        background: var(--dark-card);
        border: 1px solid var(--border);
        border-radius: 16px;
    }

    .set-row.completed {
        opacity: 0.92;
        background: var(--dark-elevated);
    }

    .set-input-group {
        display: flex;
        flex-direction: column;
        gap: 0.3rem;
    }

    .set-input-group > div {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        flex-wrap: wrap;
    }

    .set-input {
        flex: 1 1 110px;
        min-width: 110px;
        width: auto;
        text-align: center;
        padding: 0.45rem 0.65rem;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: var(--dark-elevated);
        color: var(--text);
        font-weight: 700;
        font-variant-numeric: tabular-nums;
        letter-spacing: 0.02em;
    }

    .set-input-label {
        font-size: 0.78rem;
        color: var(--text-muted);
        font-weight: 600;
    }

    .checkbox {
        width: 32px;
        height: 32px;
        border-radius: 10px;
        border: 2px solid var(--border);
        background: transparent;
        cursor: pointer;
        transition: all 0.2s ease;
        align-self: flex-end;
    }

    .checkbox.checked {
        background: var(--primary);
        border-color: var(--primary);
    }

    /* Settings Styles */
    .settings-container {
        padding: 1.5rem;
        max-width: 700px;
        margin: 0 auto;
    }

    .settings-section {
        background: var(--dark-card);
        border-radius: 20px;
        padding: 2rem;
        border: 1px solid var(--border);
        box-shadow: var(--shadow);
    }

    .settings-section h2 {
        font-size: 1.75rem;
        font-weight: 700;
        margin-bottom: 2rem;
        color: var(--text);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .settings-section h3 {
        font-size: 1.25rem;
        font-weight: 700;
        margin: 2.5rem 0 1.5rem 0;
        color: var(--text);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .settings-item {
        display: grid;
        grid-template-columns: 1fr auto;
        align-items: center;
        padding: 1.5rem 0;
        gap: 2rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .settings-item:first-of-type {
        padding-top: 0;
    }

    .settings-item:last-of-type {
        border-bottom: none;
        padding-bottom: 0;
    }

    .settings-label {
        display: flex;
        flex-direction: column;
        gap: 0.375rem;
        min-width: 0;
    }

    .settings-label > span:first-child {
        font-weight: 600;
        font-size: 1rem;
        color: var(--text);
    }

    .settings-description {
        font-size: 0.875rem;
        color: var(--text-muted);
        line-height: 1.4;
    }

    .settings-divider {
        height: 1px;
        background: var(--border);
        margin: 1.5rem 0;
    }

    .settings-control {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        flex-shrink: 0;
    }

    .settings-input {
        width: 100px;
        padding: 0.625rem 0.875rem;
        border-radius: 12px;
        border: 2px solid var(--border);
        background: var(--dark-elevated);
        color: var(--text);
        font-size: 1rem;
        font-weight: 600;
        text-align: center;
        transition: all 0.2s;
    }

    .settings-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(52, 199, 89, 0.1);
    }

    .settings-counter {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: var(--dark-elevated);
        border-radius: 12px;
        padding: 0.375rem;
        border: 1px solid var(--border);
        box-shadow: 0 0 0 1px rgba(255,255,255,0.05);
    }

    .settings-counter button {
        width: 38px;
        height: 38px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        font-weight: 600;
        background: var(--dark);
        border: 1px solid var(--border);
        color: var(--text);
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .settings-counter button:hover {
        background: var(--dark-elevated);
        border-color: var(--primary);
        transform: scale(1.05);
    }

    .settings-counter button:active {
        transform: scale(0.95);
    }

    .settings-counter input {
        width: 56px;
        text-align: center;
        border: none;
        background: transparent;
        color: var(--text);
        font-size: 1.125rem;
        font-weight: 700;
        pointer-events: none;
    }

    .settings-backup-grid {
        display: grid;
        gap: 0.875rem;
        margin-bottom: 1.5rem;
    }

    .settings-tip {
        padding: 1rem 1.25rem;
        background: rgba(52, 199, 89, 0.08);
        border-radius: 12px;
        border: 1px solid rgba(52, 199, 89, 0.2);
    }

    .settings-tip p {
        color: var(--text-muted);
        font-size: 0.875rem;
        line-height: 1.6;
        margin: 0;
    }

    .settings-version {
        display: inline-flex;
        align-items: center;
        padding: 0.5rem 0.875rem;
        background: var(--dark-elevated);
        border: 1px solid var(--border);
        border-radius: 10px;
        font-weight: 600;
        color: var(--text-muted);
        font-size: 0.875rem;
    }

    @media (max-width: 640px) {
        .settings-item {
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .settings-control {
            justify-content: flex-start;
        }
    }

    /* Toggle Switch */
    .toggle-switch {
        position: relative;
        width: 88px;
        height: 38px;
        background: var(--dark-elevated);
        border-radius: 19px;
        cursor: pointer;
        border: 1px solid var(--border);
        box-shadow: 0 0 0 1px rgba(255,255,255,0.08);
        transition: all 0.25s ease;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 4px;
        gap: 4px;
        flex-shrink: 0;
    }

    .toggle-switch.active {
        background: var(--primary);
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(52,199,89,0.3);
    }

    .toggle-slider {
        width: 30px;
        height: 30px;
        background: var(--text);
        border-radius: 14px;
        transition: transform 0.3s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.25);
    }

    .toggle-switch.active .toggle-slider {
        transform: translateX(26px);
    }

    .toggle-icon {
        font-size: 1rem;
        color: var(--text-muted);
        line-height: 1;
    }

    .toggle-switch.active .toggle-icon {
        color: var(--dark);
        opacity: 0.9;
    }

</style>

<!-- Boot error overlay for diagnosing iOS white screens -->
<div id="boot-error-overlay"><div class="content">
        <h2>Er is een fout opgetreden bij het laden</h2>
        <p id="boot-error-text">Onbekende fout. Probeer de app te herladen.</p>
        <button onclick="location.reload()" style="margin-top:12px;padding:10px 16px;background:#FF3B30;color:#fff;border:none;border-radius:8px;">Herladen</button>
</div></div>

<script>
// Voeg automatisch een test custom schema toe als er nog geen custom schemas zijn
document.addEventListener('DOMContentLoaded', function() {
    try {
        const stored = localStorage.getItem('gym_custom_schemas');
        if (!stored || stored === '{}' || stored === '[]') {
            const testSchema = {
                id: 'test-1',
                name: 'Voorbeeld schema',
                description: 'Dit is een automatisch toegevoegd testschema.',
                color: '#34C759',
                muscleGroups: [
                    { id: 'custom', name: 'Custom', exercises: [
                        { id: 1, name: 'Push-up', met: 5.0 },
                        { id: 2, name: 'Squat', met: 5.0 }
                    ]}
                ]
            };
            // Opslaan als object (oude code gebruikt object, sommige als array)
            localStorage.setItem('gym_custom_schemas', JSON.stringify({ [testSchema.id]: testSchema }));
            console.log('[init] Test custom schema toegevoegd aan localStorage');
        }
    } catch (e) {
        console.error('[init] Fout bij toevoegen test custom schema:', e);
    }
});
// Console log overlay logic
(function(){
    const overlay = document.getElementById('console-log-overlay');
    const content = document.getElementById('console-log-content');
    if (!overlay || !content) return;
    function appendLog(msg, type) {
        if (!getSettings().loggingEnabled) return;
        const el = document.createElement('div');
        el.textContent = `[${type}] ${msg}`;
        el.style.marginBottom = '2px';
        if(type==='error') el.style.color = '#FF3B30';
        if(type==='warn') el.style.color = '#FFCC00';
        content.appendChild(el);
        overlay.style.display = 'block';
        // Scroll to bottom
        content.scrollTop = content.scrollHeight;
    }
    const origLog = console.log;
    const origErr = console.error;
    const origWarn = console.warn;
    console.log = function(...args){ appendLog(args.join(' '), 'log'); origLog.apply(console, args); };
    console.error = function(...args){ appendLog(args.join(' '), 'error'); origErr.apply(console, args); };
    console.warn = function(...args){ appendLog(args.join(' '), 'warn'); origWarn.apply(console, args); };
    window.addEventListener('error', function(e){ appendLog(e.message + ' @ ' + (e.filename||'') + ':' + (e.lineno||''), 'error'); });
    window.addEventListener('unhandledrejection', function(e){ appendLog('Unhandled promise rejection: ' + (e.reason && e.reason.message ? e.reason.message : e.reason), 'error'); });
})();
// Basic boot error capture to reveal white-screen causes
(function(){
    function showBootError(msg){
        var el = document.getElementById('boot-error-overlay');
        var txt = document.getElementById('boot-error-text');
        if(el && txt){ txt.textContent = String(msg || 'Onbekende fout'); el.style.display = 'flex'; }
    }
    window.addEventListener('error', function(e){
        // Only show early boot errors (first 5s)
        if(performance.now() < 5000){ showBootError(e.message || 'Scriptfout'); }
    });
    window.addEventListener('unhandledrejection', function(e){
        if(performance.now() < 5000){ showBootError((e.reason && e.reason.message) || 'Promise fout'); }
    });
})();
</script>

<div class="container">
    <div class="header">
        <div class="header-top">
            <h1> Gym Tracker</h1>
        </div>
        <div class="header-tabs">
            <button class="tab active" data-view="workout" onclick="switchView('workout')"> Workout</button>
            <button class="tab" data-view="history" onclick="switchView('history')"> Historie</button>
            <button class="tab" data-view="progress" onclick="switchView('progress')"> Progressie</button>
            <button class="tab" data-view="prs" onclick="switchView('prs')"> PRs</button>
            <button class="tab" data-view="exercises" onclick="switchView('exercises')"> 💪 Oefeningen</button>
            <button class="tab" data-view="schemas" onclick="switchView('schemas')"> 📋 Schema beheer</button>
            <button class="tab" data-view="settings" onclick="switchView('settings')"> ⚙️ Instellingen</button>
        </div>
        <!-- Schema beheer View wordt verplaatst naar buiten de header, op gelijk niveau met andere views -->
    <!-- Schema beheer View (verplaatst) -->
    <div id="schemasView" class="view">
        <div class="settings-container">
            <div class="settings-section">
                <h2>📋 Schema beheer</h2>
                <p style="color: var(--text-muted); margin-bottom: 1.5rem;">Overzicht van alle beschikbare schemas (standaard + eigen)</p>
                <div id="customSchemasList"></div>
                <div style="margin-top: 2rem;">
                    <button id="addSchemaBtn" onclick="showAddSchemaForm()" style="width: 100%; padding: 0.75rem; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 600;">➕ Nieuw Schema Toevoegen</button>
                </div>
                <div id="addSchemaForm" style="display:none; margin-top: 2rem; padding: 1.5rem; background: var(--dark-card); border-radius: 12px; border: 1px solid var(--border);">
                    <h3 id="schemaFormTitle">Nieuw schema</h3>
                    <div style="display: grid; gap: 1rem; margin-top: 1rem;">
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Schema Naam *</label>
                            <input id="schemaNameInput" type="text" placeholder="bijv. Full Body" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; background: var(--dark-lighter); color: var(--text);">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Beschrijving</label>
                            <input id="schemaDescInput" type="text" placeholder="bijv. Complete workout" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; background: var(--dark-lighter); color: var(--text);">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Kleur *</label>
                            <input id="schemaColorInput" type="color" value="#34C759" style="width: 100%; height: 3rem; border: 1px solid var(--border); border-radius: 8px; background: var(--dark-lighter);">
                        </div>
                        <div id="schemaExercisesSection" style="display:none;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Oefeningen</label>
                            <div id="schemaExercisesList" style="max-height: 200px; overflow-y: auto; margin-bottom: 1rem;"></div>
                            <div style="display: flex; gap: 0.5rem;">
                                <select id="exerciseNameInput" style="flex: 1; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; background: var(--dark-lighter); color: var(--text);">
                                    <option value="">-- Selecteer oefening --</option>
                                </select>
                                <button onclick="addExerciseToSchemaForm()" style="padding: 0.75rem 1rem; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 600;">Toevoegen</button>
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                            <button id="schemaSaveBtn" onclick="saveNewSchema()" style="flex: 1; padding: 0.75rem; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 600;">Opslaan</button>
                            <button onclick="hideAddSchemaForm()" style="flex: 1; padding: 0.75rem; background: var(--dark-lighter); color: var(--text); border: 1px solid var(--border); border-radius: 8px; font-weight: 600;">Annuleren</button>
                        </div>
                    </div>
                </div>
                <div id="schemaUiError" style="display:none;color:#FF3B30;margin-top:10px;"></div>
            </div>
        </div>
    </div>
    <script>
    // UI logica voor Schema beheer tabblad
    let schemaFormMode = 'add'; // 'add' of 'edit'
    let editingSchemaId = null;
    let editingExercises = [];

    function switchView(view) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
        const el = document.getElementById(view + 'View');
        if (el) {
            el.classList.add('active');
            el.style.display = '';
            if (view === 'schemas') renderCustomSchemasList();
        }
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        const tab = document.querySelector('.tab[data-view="' + view + '"]');
        if (tab) tab.classList.add('active');
    }

    // Fallback: altijd een view tonen na laden
    document.addEventListener('DOMContentLoaded', function() {
        const anyActive = document.querySelector('.view.active');
        if (!anyActive) {
            switchView('workout');
        }
    });

    function renderCustomSchemasList() {
        console.log('[renderCustomSchemasList] called');
        const list = document.getElementById('customSchemasList');
        const errorDiv = document.getElementById('schemaUiError');
        if (!list) {
            console.error('[renderCustomSchemasList] customSchemasList element not found');
            if (errorDiv) {
                errorDiv.style.display = '';
                errorDiv.textContent = 'Kan lijst van schemas niet tonen (UI-fout). Probeer te herladen.';
            }
            return;
        } else if (errorDiv) {
            errorDiv.style.display = 'none';
        }
        const allSchemas = getAllSchemas();
        console.log('[renderCustomSchemasList] all schemas:', allSchemas);
        list.innerHTML = '';
        allSchemas.forEach(schema => {
            const isDefault = schema.id.startsWith('schema');
            const oefList = (schema.muscleGroups && schema.muscleGroups.length > 0)
                ? schema.muscleGroups.map(g => g.exercises.map(e => e.name).join(", ")).join(" | ")
                : '';
            const actions = isDefault 
                ? '<small style="color: var(--text-muted);">(standaard - niet aanpasbaar)</small>'
                : `<button onclick=\"editSchemaForm('${schema.id}')\" style="padding: 0.5rem 1rem; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 600; margin-right: 0.5rem;">Bewerken</button> <button onclick=\"deleteCustomSchemaUI('${schema.id}')\" style="padding: 0.5rem 1rem; background: var(--danger); color: white; border: none; border-radius: 8px; font-weight: 600;">Verwijderen</button>`;
            list.innerHTML += `<div style="background: ${schema.color}; color: white; padding: 1rem; border-radius: 12px; margin-bottom: 1rem; border: 1px solid var(--border);">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                    <h3 style="margin: 0; font-size: 1.2rem; font-weight: 700;">${schema.name}</h3>
                </div>
                ${schema.description ? `<p style="margin: 0.5rem 0; color: rgba(255,255,255,0.9);">${schema.description}</p>` : ''}
                <p style="margin: 0.5rem 0; font-size: 0.9rem; color: rgba(255,255,255,0.8);"><strong>Oefeningen:</strong> ${oefList || 'geen'}</p>
                <div style="margin-top: 1rem;">${actions}</div>
            </div>`;
        });
        // Zorg dat de "Nieuw schema toevoegen" knop altijd zichtbaar is
        const addBtn = document.getElementById('addSchemaBtn');
        if (addBtn) addBtn.style.display = '';
    }

    function showAddSchemaForm() {
            console.log('[showAddSchemaForm] called');
        schemaFormMode = 'add';
        editingSchemaId = null;
        editingExercises = [];
        if (document.getElementById('schemaFormTitle')) document.getElementById('schemaFormTitle').innerText = 'Nieuw schema';
        if (document.getElementById('schemaNameInput')) document.getElementById('schemaNameInput').value = '';
        if (document.getElementById('schemaDescInput')) document.getElementById('schemaDescInput').value = '';
        if (document.getElementById('schemaColorInput')) document.getElementById('schemaColorInput').value = getNextSchemaColor();
        populateExerciseSelect();
        if (document.getElementById('schemaExercisesSection')) document.getElementById('schemaExercisesSection').style.display = '';
        renderSchemaExercisesList();
        if (document.getElementById('addSchemaForm')) document.getElementById('addSchemaForm').style.display = '';
        if (document.getElementById('schemaSaveBtn')) document.getElementById('schemaSaveBtn').onclick = saveNewSchema;
        // Zorg dat de form altijd zichtbaar is als de knop is gebruikt
        const addBtn = document.getElementById('addSchemaBtn');
        if (addBtn) addBtn.style.display = '';
    }
    function hideAddSchemaForm() {
            console.log('[hideAddSchemaForm] called');
        if (document.getElementById('addSchemaForm')) document.getElementById('addSchemaForm').style.display = 'none';
        // Reset save knop naar saveNewSchema na sluiten
        if (document.getElementById('schemaSaveBtn')) document.getElementById('schemaSaveBtn').onclick = saveNewSchema;
        // Zorg dat de "Nieuw schema toevoegen" knop altijd zichtbaar blijft
        const addBtn = document.getElementById('addSchemaBtn');
        if (addBtn) addBtn.style.display = '';
    }
    function saveNewSchema() {
            console.log('[saveNewSchema] called');
        const name = (document.getElementById('schemaNameInput')||{}).value ? document.getElementById('schemaNameInput').value.trim() : '';
        const desc = (document.getElementById('schemaDescInput')||{}).value ? document.getElementById('schemaDescInput').value.trim() : '';
        const color = (document.getElementById('schemaColorInput')||{}).value || '#34C759';
        if (!name) return alert('Naam is verplicht');
        if (!Array.isArray(editingExercises)) editingExercises = [];
        const muscleGroups = groupExercisesByMuscleGroup(editingExercises);
        addCustomSchema({ name, description: desc, color, icon: "💪", muscleGroups });
        hideAddSchemaForm();
        renderCustomSchemasList();
    }
    function deleteCustomSchemaUI(id) {
            console.log('[deleteCustomSchemaUI] called for id:', id);
        if (id.startsWith('schema')) {
            alert('Standaard schemas kunnen niet worden verwijderd.');
            return;
        }
        if (confirm('Weet je zeker dat je dit schema wilt verwijderen?')) {
            deleteCustomSchema(id);
            renderCustomSchemasList();
        }
    }
    function editSchemaForm(id) {
            console.log('[editSchemaForm] called for id:', id);
        if (id.startsWith('schema')) {
            alert('Standaard schemas kunnen niet worden bewerkt.');
            return;
        }
        schemaFormMode = 'edit';
        editingSchemaId = id;
        const custom = getCustomSchemas();
        const schema = custom.find(s => s.id === id);
        if (!schema) return;
        if (document.getElementById('schemaFormTitle')) document.getElementById('schemaFormTitle').innerText = 'Schema bewerken';
        if (document.getElementById('schemaNameInput')) document.getElementById('schemaNameInput').value = schema.name;
        if (document.getElementById('schemaDescInput')) document.getElementById('schemaDescInput').value = schema.description;
        if (document.getElementById('schemaColorInput')) document.getElementById('schemaColorInput').value = schema.color;
        populateExerciseSelect();
        // Oefeningen laden - alle oefeningen uit alle groepen
        editingExercises = [];
        if (schema.muscleGroups) {
            schema.muscleGroups.forEach(group => {
                if (group.exercises) {
                    editingExercises.push(...group.exercises.map(e => ({ ...e })));
                }
            });
        }
        if (document.getElementById('schemaExercisesSection')) document.getElementById('schemaExercisesSection').style.display = '';
        renderSchemaExercisesList();
        if (document.getElementById('addSchemaForm')) document.getElementById('addSchemaForm').style.display = '';
        if (document.getElementById('schemaSaveBtn')) document.getElementById('schemaSaveBtn').onclick = saveEditSchema;
    }
    function saveEditSchema() {
            console.log('[saveEditSchema] called');
        const name = (document.getElementById('schemaNameInput')||{}).value ? document.getElementById('schemaNameInput').value.trim() : '';
        const desc = (document.getElementById('schemaDescInput')||{}).value ? document.getElementById('schemaDescInput').value.trim() : '';
        const color = (document.getElementById('schemaColorInput')||{}).value || '#34C759';
        if (!name) return alert('Naam is verplicht');
        if (!Array.isArray(editingExercises)) editingExercises = [];
        const muscleGroups = groupExercisesByMuscleGroup(editingExercises);
        updateCustomSchema(editingSchemaId, { name, description: desc, color, icon: "💪", muscleGroups });
        hideAddSchemaForm();
        renderCustomSchemasList();
    }
    function populateExerciseSelect() {
        const select = document.getElementById('exerciseNameInput');
        if (!select) return;
        select.innerHTML = '<option value="">-- Selecteer oefening --</option>';
        const allExercises = getAllExercises();
        allExercises.forEach(exercise => {
            const option = document.createElement('option');
            option.value = exercise.name;
            option.textContent = `${exercise.name} (${exercise.muscleGroup || 'Custom'})`;
            select.appendChild(option);
        });
    }
    function addExerciseToSchemaForm() {
            console.log('[addExerciseToSchemaForm] called');
        const name = (document.getElementById('exerciseNameInput')||{}).value ? document.getElementById('exerciseNameInput').value.trim() : '';
        if (!name) return;
        if (!Array.isArray(editingExercises)) editingExercises = [];
        // Find the exercise to get met and muscleGroup
        const allExercises = getAllExercises();
        const exercise = allExercises.find(e => e.name === name);
        if (!exercise) return alert('Oefening niet gevonden');
        // Check if already added
        if (editingExercises.some(e => e.name === name)) return alert('Oefening al toegevoegd');
        // Uniek id genereren
        const id = Date.now() + Math.floor(Math.random()*1000);
        editingExercises.push({ id, name, met: exercise.met, muscleGroup: exercise.muscleGroup || 'Custom' });
        if (document.getElementById('exerciseNameInput')) document.getElementById('exerciseNameInput').value = '';
        renderSchemaExercisesList();
    }
    function removeExerciseFromSchemaForm(idx) {
            console.log('[removeExerciseFromSchemaForm] called for idx:', idx);
        if (!Array.isArray(editingExercises)) editingExercises = [];
        editingExercises.splice(idx, 1);
        renderSchemaExercisesList();
    }
    function renderSchemaExercisesList() {
            console.log('[renderSchemaExercisesList] called');
        const list = document.getElementById('schemaExercisesList');
        if (!list) return;
        if (!Array.isArray(editingExercises)) editingExercises = [];
        list.innerHTML = '';
        editingExercises.forEach((ex, idx) => {
            list.innerHTML += `<div style='display:flex;align-items:center;gap:8px;margin:2px 0;'>
                <span>${ex.name}</span>
                <button onclick="removeExerciseFromSchemaForm(${idx})" style='font-size:0.9em;'>Verwijder</button>
            </div>`;
        });
    }
    </script>
    </div>

    <!-- Workout View -->
    <div id="workoutView" class="view active">
        <div id="schemaSelection" class="schema-grid">
            <!-- Dynamically filled -->
        </div>

        <div id="activeWorkout" style="display: none;">
            <div class="timer-card" id="timerCard">
                <div class="timer-content">
                    <div class="timer-label">Workout Tijd</div>
                    <div class="timer" id="timer">00:00</div>
                    <div class="timer-meta" id="exerciseMeta">Oefeningen: 0/0</div>
                    <div class="timer-inline-stats">
                        <div class="timer-stat">
                            <span class="timer-stat-label">Sets</span>
                            <span class="timer-stat-value" id="statSets">0</span>
                        </div>
                        <div class="timer-stat">
                            <span class="timer-stat-label">Kcal 🔥</span>
                            <span class="timer-stat-value" id="statKcal">0</span>
                        </div>
                    </div>
                    <div class="timer-controls">
                        <button class="btn btn-secondary" onclick="toggleTimer()" id="timerBtn">
                            <span id="timerIcon"></span>
                            <span id="timerText">Start</span>
                        </button>
                        <button class="btn btn-secondary" onclick="resetTimer()"> Reset</button>
                    </div>
                </div>
            </div>

            <div class="rest-timer-card" id="restTimerCard">
                <div class="rest-timer-header">
                    <div class="rest-timer-title" id="restTimerLabel">Rust: 1:30</div>
                    <div class="rest-timer-actions">
                        <button class="btn btn-secondary" style="padding:0.35rem 0.75rem; font-size:0.85rem;" onclick="refreshRestTimer()">Refresh</button>
                        <button class="btn btn-secondary" style="padding:0.35rem 0.75rem; font-size:0.85rem;" onclick="stopRestTimer()">Stop</button>
                    </div>
                </div>
                <div class="rest-timer-progress">
                    <div id="restTimerProgress"></div>
                </div>
            </div>

            <div id="exercisesContainer"></div>
        </div>
    </div>

    <!-- History View -->
    <div id="historyView" class="view">
        <div class="calendar-container" id="calendarContainer"></div>
        <div id="historyContainer"></div>
    </div>

    <!-- Progress View -->
    <div id="progressView" class="view">
        <div id="progressContainer"></div>
    </div>

    <!-- PRs View -->
    <div id="prsView" class="view">
        <div id="prsContainer"></div>
    </div>

    <!-- Settings View -->
    <div id="settingsView" class="view">
        <div class="settings-container">
            <div class="settings-section">
                <h2>⚙️ Instellingen</h2>

                <div class="settings-item">
                    <div class="settings-label">
                        <span>App Versie</span>
                        <span class="settings-description">Actieve build op dit device</span>
                    </div>
                    <div class="settings-control">
                        <span id="appVersionText" class="settings-version">…</span>
                    </div>
                </div>

                <div class="settings-item">
                    <div class="settings-label">
                        <span>Cache Opnieuw Laden</span>
                        <span class="settings-description">Forceer herladen naar nieuwste versie</span>
                    </div>
                    <button class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.875rem;" onclick="forceReload()">
                        🔄 Herladen
                    </button>
                </div>

                <div class="settings-divider"></div>
                
                <div class="settings-item">
                    <div class="settings-label">
                        <span>Donker Thema</span>
                        <span class="settings-description">Schakel tussen donker en licht thema</span>
                    </div>
                    <div class="settings-control">
                        <div class="toggle-switch" id="themeToggle" onclick="toggleDarkMode()" title="Toggle dark/light mode">
                            <span class="toggle-icon">🌙</span>
                            <div class="toggle-slider"></div>
                            <span class="toggle-icon">☀️</span>
                        </div>
                    </div>
                </div>

                <div class="settings-item">
                    <div class="settings-label">
                        <span>Debug Logging</span>
                        <span class="settings-description">Toon console logs voor debugging</span>
                    </div>
                    <div class="settings-control">
                        <div class="toggle-switch" id="loggingToggle" onclick="toggleLogging()" title="Toggle debug logging">
                            <span class="toggle-icon">🔇</span>
                            <div class="toggle-slider"></div>
                            <span class="toggle-icon">🔊</span>
                        </div>
                    </div>
                </div>

                <div class="settings-divider"></div>

                <h3>📦 Backup & Synchronisatie</h3>
                
                <div class="settings-backup-grid">
                    <button class="btn btn-primary" onclick="exportBackup()" style="width: 100%;">
                        ⬇️ Export Data
                    </button>
                    <button class="btn btn-secondary" onclick="importBackup()" style="width: 100%;">
                        ⬆️ Import Data
                    </button>
                    <input type="file" id="importFileInput" accept=".json" style="display: none;" onchange="handleImportFile(event)">
                    <div class="settings-tip">
                        <p>
                            💡 Tip: Backup bevat al je workouts, PRs en instellingen. Bewaar in OneDrive voor sync tussen apparaten.
                        </p>
                    </div>
                </div>

                <div class="settings-divider"></div>

                <div class="settings-item">
                    <div class="settings-label">
                        <span>Lichaamsgewicht</span>
                        <span class="settings-description">Gebruikt voor calorieberekening (kg)</span>
                    </div>
                    <div class="settings-counter">
                        <button onclick="updateBodyWeight((parseInt(document.getElementById('bodyWeightInput').value) || 75) - 1)">−</button>
                        <input type="number" id="bodyWeightInput" min="30" max="200" value="75" readonly>
                        <button onclick="updateBodyWeight((parseInt(document.getElementById('bodyWeightInput').value) || 75) + 1)">+</button>
                    </div>
                </div>

                <div class="settings-item">
                    <div class="settings-label">
                        <span>Standaard Sets</span>
                        <span class="settings-description">Aantal sets per oefening</span>
                    </div>
                    <div class="settings-counter">
                        <button onclick="updateDefaultSets((parseInt(document.getElementById('defaultSetsInput').value) || 3) - 1)">−</button>
                        <input type="number" id="defaultSetsInput" min="1" max="10" value="3" readonly>
                        <button onclick="updateDefaultSets((parseInt(document.getElementById('defaultSetsInput').value) || 3) + 1)">+</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Exercises View -->
    <div id="exercisesView" class="view">
        <div class="settings-container">
            <div class="settings-section">
                <h2>💪 Oefeningen</h2>
                <p style="color: var(--text-muted); margin-bottom: 1.5rem;">Overzicht van alle beschikbare oefeningen (standaard + eigen)</p>
                <div style="margin-bottom: 1rem;">
                    <button onclick="showInlineExerciseForm()" style="width: 100%; padding: 0.75rem; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 600;">➕ Nieuwe Oefening Toevoegen</button>
                </div>
                <div id="exercisesList"></div>
            </div>
        </div>
    </div>
</div>

<!-- Inline Add Exercise Form (shown when FAB clicked) -->
<div id="inlineAddExercise" style="display: none; margin: 1rem 0; padding: 1rem; background: var(--dark-card); border-radius: 12px; border: 1px solid var(--border);">
    <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
        <button id="addNewExerciseBtn" onclick="showNewExerciseForm()" style="flex: 1; padding: 0.5rem; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 600;">Nieuwe oefening</button>
        <button id="addExistingExerciseBtn" onclick="showExistingExerciseForm()" style="flex: 1; padding: 0.5rem; background: var(--dark-lighter); color: var(--text); border: 1px solid var(--border); border-radius: 8px; font-weight: 600;">Bestaande oefening</button>
    </div>
    
    <!-- New Exercise Form -->
    <div id="newExerciseForm" style="display: block;">
        <h3 style="margin: 0 0 1rem 0; color: var(--primary);">➕ Voeg Nieuwe Oefening Toe</h3>
        <div style="display: grid; gap: 1rem;">
            <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Oefening Naam *</label>
                <input type="text" id="inlineExerciseName" placeholder="bijv. Bicep Curls" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; background: var(--dark-lighter); color: var(--text);">
            </div>
            <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Spiergroep *</label>
                <select id="inlineMuscleGroup" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; background: var(--dark-lighter); color: var(--text);">
                    <option value="">-- Selecteer spiergroep --</option>
                </select>
            </div>
            <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">MET Waarde *</label>
                <input type="number" id="inlineExerciseMET" placeholder="bijv. 5.0" step="0.1" min="1" max="15" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; background: var(--dark-lighter); color: var(--text);">
            </div>
            <div style="display: flex; gap: 0.5rem;">
                <button onclick="saveInlineExercise()" style="flex: 1; padding: 0.75rem; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 600;">Toevoegen</button>
                <button onclick="hideInlineExerciseForm()" style="flex: 1; padding: 0.75rem; background: var(--dark-lighter); color: var(--text); border: 1px solid var(--border); border-radius: 8px; font-weight: 600;">Annuleren</button>
            </div>
        </div>
    </div>
    
    <!-- Existing Exercise Form -->
    <div id="existingExerciseForm" style="display: none;">
        <h3 style="margin: 0 0 1rem 0; color: var(--primary);">📚 Voeg Bestaande Oefening Toe</h3>
        <div id="existingExercisesList" style="max-height: 300px; overflow-y: auto; margin-bottom: 1rem;">
            <!-- Exercises will be populated here -->
        </div>
        <div style="display: flex; gap: 0.5rem;">
            <button onclick="hideInlineExerciseForm()" style="flex: 1; padding: 0.75rem; background: var(--dark-lighter); color: var(--text); border: 1px solid var(--border); border-radius: 8px; font-weight: 600;">Annuleren</button>
        </div>
    </div>
</div>

<!-- Floating Button for Adding Custom Exercise -->
<button class="fab-add-exercise" id="fabAddExercise" onclick="showInlineExerciseForm()" title="Voeg oefening toe">
    <span>+</span>
</button>

<div class="bottom-actions" id="bottomActions">
    <button class="btn btn-secondary" onclick="cancelWorkout()"> Annuleren</button>
    <button class="btn btn-primary" onclick="finishWorkout()"> Voltooien</button>
</div>

<div class="pr-celebration" id="prCelebration">
    <div class="pr-content">
        <div class="pr-emoji"></div>
        <div class="pr-title">NIEUW PR!</div>
        <div class="pr-detail" id="prDetail"></div>
        <div class="pr-sub" id="prSub"></div>
        <button class="btn btn-primary" onclick="closePRCelebration()">Awesome! </button>
    </div>
</div>

<div class="modal" id="settingsModal">

<!-- Add Custom Exercise Modal -->
<div class="modal" id="addExerciseModal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h2>➕ Voeg Oefening Toe</h2>
            <button class="modal-close" onclick="closeAddExerciseModal()">✕</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Oefening Naam *</label>
                <input type="text" id="customExerciseName" placeholder="bijv. Bicep Curls" class="form-input">
            </div>
            <div class="form-group">
                <label>Spiergroep *</label>
                <select id="customMuscleGroup" class="form-input">
                    <option value="">-- Selecteer spiergroep --</option>
                </select>
            </div>
            <div class="form-group">
                <label>MET Waarde * (Metabolic Equivalent)</label>
                <input type="number" id="customExerciseMET" placeholder="bijv. 5.0" step="0.1" min="1" max="15" class="form-input">
            </div>
            <div class="form-group">
                <label style="font-size: 0.85rem; color: var(--text-muted);">💡 MET bepaalt calorieverbruik. Typische waarden: 3-5 (cardio), 5-8 (kracht)</label>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeAddExerciseModal()">Annuleren</button>
            <button class="btn btn-primary" onclick="saveCustomExercise()">Toevoegen</button>
        </div>
    </div>
</div>

<div class="toast" id="toast"></div>

<script>// WORKOUT DATA
// App version for cache-busting (always bump by 1)
const APP_VERSION = "2025-12-13-16";
// Enforce versioned URL so clients always fetch the latest build
(async function enforceVersionedUrl() {
    try {
        const storedVersion = localStorage.getItem("app_version");
        const url = new URL(location.href);
        const currentV = url.searchParams.get("v");
        
        // Version mismatch detected - force clear cache and reload
        if (storedVersion && storedVersion !== APP_VERSION) {
            console.log(`🔄 Version upgrade: ${storedVersion} → ${APP_VERSION}`);
            
            // Unregister any service workers
            if ('serviceWorker' in navigator) {
                const registrations = await navigator.serviceWorker.getRegistrations();
                for (let registration of registrations) {
                    await registration.unregister();
                    console.log("🗑️ Service worker unregistered");
                }
            }
            
            // Clear caches
            if ('caches' in window) {
                const cacheNames = await caches.keys();
                await Promise.all(cacheNames.map(name => caches.delete(name)));
                console.log("🗑️ Caches cleared");
            }
            
            // Update version and force reload with cache bust
            localStorage.setItem("app_version", APP_VERSION);
            url.searchParams.set("v", APP_VERSION);
            url.searchParams.set("t", Date.now().toString());
            location.replace(url.toString());
            return;
        }
        
        // First visit or URL param mismatch
        if (currentV !== APP_VERSION) {
            url.searchParams.set("v", APP_VERSION);
            url.searchParams.set("t", Date.now().toString());
            localStorage.setItem("app_version", APP_VERSION);
            location.replace(url.toString());
            return;
        }
        
        localStorage.setItem("app_version", APP_VERSION);
        console.log("✅ App loaded:", APP_VERSION);
    } catch (e) {
        console.error("⚠️ Version check error:", e);
    }
})();

// Default schemas (niet aanpasbaar)
const DEFAULT_SCHEMAS = [
    {
        id: "schema1",
        name: "Schema 1",
        description: "Upper Body Push/Pull",
        color: "#34C759",
        icon: "",
        muscleGroups: [
            {
                id: "borst",
                name: "Borst",
                icon: "",
                exercises: [
                    { id: 101, name: "Chest Press", met: 5.0 },
                    { id: 102, name: "DB Press", met: 5.0 },
                    { id: 118, name: "DB Chest Turn Shoulder Press", met: 5.0 }
                ]
            },
            {
                id: "schouder",
                name: "Schouder",
                icon: "",
                exercises: [
                    { id: 103, name: "Flyes", met: 5.0 },
                    { id: 104, name: "Pull Down", met: 5.0 },
                    { id: 107, name: "Shoulder Press", met: 5.0 }
                ]
            },
            {
                id: "rug",
                name: "Rug",
                icon: "",
                exercises: [
                    { id: 105, name: "Seated Row", met: 5.0 }
                ]
            },
            {
                id: "triceps_biceps",
                name: "Triceps / Biceps",
                icon: "",
                exercises: [
                    { id: 106, name: "One Arm Row", met: 5.0 },
                    { id: 108, name: "Front Side Raise", met: 5.0 }
                ]
            }
        ]
    },
    {
        id: "schema2",
        name: "Schema 2",
        description: "Legs & Arms - Lower Body Focus",
        color: "#FF9500",
        icon: "",
        muscleGroups: [
            {
                id: "benen",
                name: "Benen",
                icon: "",
                exercises: [
                    { id: 109, name: "Leg Press", met: 5.0 },
                    { id: 110, name: "Leg Curl", met: 5.0 },
                    { id: 111, name: "Hack Squad", met: 5.0 }
                ]
            },
            {
                id: "triceps_biceps_2",
                name: "Triceps / Biceps",
                icon: "",
                exercises: [
                    { id: 112, name: "French Press", met: 5.0 },
                    { id: 113, name: "Biceps Barbell Curl", met: 5.0 },
                    { id: 114, name: "Incl. Dumbbell Curl", met: 5.0 },
                    { id: 115, name: "Reverse Curl", met: 5.0 },
                    { id: 116, name: "Triceps Extension", met: 5.0 },
                    { id: 117, name: "Hammer Curl DB", met: 5.0 }
                ]
            }
        ]
    }
];

// CRUD voor custom schemas (opgeslagen als array in localStorage)
function getCustomSchemas() {
        console.log('[getCustomSchemas] called');
    try {
        const stored = localStorage.getItem("gym_custom_schemas");
        const parsed = stored ? JSON.parse(stored) : [];
        return Array.isArray(parsed) ? parsed : [];
    } catch (e) {
        return [];
    }
}

function saveCustomSchemas(schemas) {
    try {
        localStorage.setItem("gym_custom_schemas", JSON.stringify(schemas));
    } catch (e) {}
}

function getNextCustomSchemaId() {
    const custom = getCustomSchemas();
    let maxId = 0;
    custom.forEach(s => {
        const n = parseInt((s.id||'').replace('custom',''));
        if (!isNaN(n) && n > maxId) maxId = n;
    });
    return `custom${maxId+1}`;
}

function getNextSchemaColor() {
    const colorPalette = [
        "#34C759", // Green (schema1)
        "#FF9500", // Orange (schema2)
        "#5AC8FA", // Blue
        "#FF3B30", // Red
        "#AF52DE", // Purple
        "#FFCC00", // Yellow
        "#32D74B", // Light Green
        "#FF9F0A", // Dark Orange
        "#64D2FF", // Light Blue
        "#FF453A"  // Light Red
    ];
    const allSchemas = getAllSchemas();
    const usedColors = allSchemas.map(s => s.color);
    for (const color of colorPalette) {
        if (!usedColors.includes(color)) {
            return color;
        }
    }
    // If all used, return first
    return colorPalette[0];
}

function groupExercisesByMuscleGroup(exercises) {
    const groups = {};
    exercises.forEach(ex => {
        const groupName = ex.muscleGroup || 'Custom';
        if (!groups[groupName]) {
            groups[groupName] = [];
        }
        groups[groupName].push(ex);
    });
    return Object.entries(groups).map(([name, exs]) => ({
        id: name.toLowerCase().replace(/\s+/g, '_'),
        name: name,
        icon: "",
        exercises: exs
    }));
}

function getAllSchemas() {
    const custom = getCustomSchemas();
    if (!Array.isArray(custom)) {
        console.error('getCustomSchemas did not return an array:', custom);
        return [...DEFAULT_SCHEMAS];
    }
    return [...DEFAULT_SCHEMAS, ...custom];
}

function addCustomSchema(schema) {
    const custom = getCustomSchemas();
    const id = getNextCustomSchemaId();
    custom.push({ ...schema, id });
    saveCustomSchemas(custom);
}

function updateCustomSchema(id, updates) {
    const custom = getCustomSchemas();
    const idx = custom.findIndex(s => s.id === id);
    if (idx !== -1) {
        custom[idx] = { ...custom[idx], ...updates };
        saveCustomSchemas(custom);
    }
}

function deleteCustomSchema(id) {
    let custom = getCustomSchemas();
    custom = custom.filter(s => s.id !== id);
    saveCustomSchemas(custom);
}

const WORKOUT_DATA = {
    get schemas() {
        return getAllSchemas();
    }
};

// STATE
let currentView = "workout";
const collapsedExercises = {};
let currentWorkout = null;
let timerInterval = null;
let timerSeconds = 0;
let timerRunning = false;
let restTimerInterval = null;
let restTimerRemaining = 0;
const REST_DURATION_SECONDS = 90;
let progressState = { schemaId: null, exerciseId: null };

// CUSTOM EXERCISES MANAGEMENT
function getCustomExercises() {
    try {
        const stored = localStorage.getItem("gym_custom_exercises");
        return stored ? JSON.parse(stored) : {};
    } catch (e) {
        return {};
    }
}

function saveCustomExercises(exercises) {
    try {
        localStorage.setItem("gym_custom_exercises", JSON.stringify(exercises));
    } catch (e) {}
}

function getAllExercises() {
    const allExercises = [];
    
    // Add standard exercises
    WORKOUT_DATA.schemas.forEach(schema => {
        schema.muscleGroups.forEach(group => {
            group.exercises.forEach(exercise => {
                allExercises.push({
                    ...exercise,
                    muscleGroup: group.name
                });
            });
        });
    });
    
    // Add custom exercises
    const custom = getCustomExercises();
    Object.values(custom).forEach(exercise => {
        allExercises.push({
            ...exercise,
            custom: true
        });
    });
    
    // Sort by name
    allExercises.sort((a, b) => a.name.localeCompare(b.name));
    
    return allExercises;
}

function getNextCustomExerciseId() {
    const custom = getCustomExercises();
    const existingIds = Object.keys(custom).map(k => parseInt(k));
    const maxId = Math.max(0, ...existingIds);
    return 9000 + (maxId >= 9000 ? maxId - 9000 + 1 : 1);
}

// SETTINGS
function getSettings() {
    const defaults = {
        bodyWeight: 75,
        defaultSets: 3,
        loggingEnabled: false
    };
    const stored = localStorage.getItem("gym_settings");
    return stored ? { ...defaults, ...JSON.parse(stored) } : defaults;
}

function saveSettings(settings) {
    try {
        localStorage.setItem("gym_settings", JSON.stringify(settings));
    } catch (e) {}
}

// COLOR HELPERS
function shadeColor(hex, percent) {
    if (typeof hex !== "string" || !/^#([0-9A-Fa-f]{6})$/.test(hex)) return hex || "#34C759";
    const num = parseInt(hex.slice(1), 16);
    const amt = Math.round(2.55 * percent);
    const r = (num >> 16) + amt;
    const g = ((num >> 8) & 0x00FF) + amt;
    const b = (num & 0x0000FF) + amt;
    return `#${(
        0x1000000 +
        (r < 255 ? (r < 0 ? 0 : r) : 255) * 0x10000 +
        (g < 255 ? (g < 0 ? 0 : g) : 255) * 0x100 +
        (b < 255 ? (b < 0 ? 0 : b) : 255)
    ).toString(16).slice(1)}`;
}

function getSchemaAccentPair(color) {
    const accent = (typeof color === "string" && color.startsWith("#")) ? color : "#34C759";
    return {
        accent,
        accent2: shadeColor(accent, -12)
    };
}

function getSchemaColor(schemaId) {
    const schema = WORKOUT_DATA.schemas.find(s => s.id === schemaId);
    return (schema && schema.color) ? schema.color : "#34C759";
}

function hexToRgba(hex, alpha = 0.35) {
    if (typeof hex !== "string" || !/^#([0-9A-Fa-f]{6})$/.test(hex)) return `rgba(52, 199, 89, ${alpha})`;
    const num = parseInt(hex.slice(1), 16);
    const r = (num >> 16) & 255;
    const g = (num >> 8) & 255;
    const b = num & 255;
    return `rgba(${r}, ${g}, ${b}, ${alpha})`;
}

// CUSTOM EXERCISE MANAGEMENT
function getAllMuscleGroups() {
    const muscleGroups = new Map();
    
    WORKOUT_DATA.schemas.forEach(schema => {
        schema.muscleGroups.forEach(group => {
            if (!muscleGroups.has(group.id)) {
                muscleGroups.set(group.id, group.name);
            }
        });
    });
    
    return Array.from(muscleGroups.entries()).sort((a, b) => a[1].localeCompare(b[1]));
}

function showInlineExerciseForm() {
    const form = document.getElementById('inlineAddExercise');
    if (!form) return;
    
    // Show new exercise form by default
    showNewExerciseForm();
    form.style.display = 'block';
    form.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function showNewExerciseForm() {
    document.getElementById('newExerciseForm').style.display = 'block';
    document.getElementById('existingExerciseForm').style.display = 'none';
    document.getElementById('addNewExerciseBtn').style.background = 'var(--primary)';
    document.getElementById('addNewExerciseBtn').style.color = 'white';
    document.getElementById('addExistingExerciseBtn').style.background = 'var(--dark-lighter)';
    document.getElementById('addExistingExerciseBtn').style.color = 'var(--text)';
    
    // Populate muscle groups for new exercise form
    const selectEl = document.getElementById('inlineMuscleGroup');
    selectEl.innerHTML = '<option value="">-- Selecteer spiergroep --</option>';
    getAllMuscleGroups().forEach(([id, name]) => {
        const option = document.createElement('option');
        option.value = id;
        option.textContent = name;
        selectEl.appendChild(option);
    });
}

function showExistingExerciseForm() {
    document.getElementById('newExerciseForm').style.display = 'none';
    document.getElementById('existingExerciseForm').style.display = 'block';
    document.getElementById('addNewExerciseBtn').style.background = 'var(--dark-lighter)';
    document.getElementById('addNewExerciseBtn').style.color = 'var(--text)';
    document.getElementById('addExistingExerciseBtn').style.background = 'var(--primary)';
    document.getElementById('addExistingExerciseBtn').style.color = 'white';
    
    // Populate existing exercises list
    populateExistingExercises();
}

function populateExistingExercises() {
    const container = document.getElementById('existingExercisesList');
    if (!container) return;
    
    // Get all exercises (standard + custom)
    const allExercises = [];
    
    // Add standard exercises from schemas
    WORKOUT_DATA.schemas.forEach(schema => {
        schema.muscleGroups.forEach(group => {
            group.exercises.forEach(exercise => {
                allExercises.push({
                    ...exercise,
                    muscleGroup: group.name,
                    muscleGroupIcon: group.icon,
                    isCustom: false
                });
            });
        });
    });
    
    // Add custom exercises
    const customExercises = getCustomExercises();
    Object.values(customExercises).forEach(exercise => {
        // Find the muscle group info
        let muscleGroup = null;
        for (const schema of WORKOUT_DATA.schemas) {
            const group = schema.muscleGroups.find(g => g.id === exercise.muscleGroupId);
            if (group) {
                muscleGroup = group;
                break;
            }
        }
        
        if (muscleGroup) {
            allExercises.push({
                ...exercise,
                muscleGroup: muscleGroup.name,
                muscleGroupIcon: muscleGroup.icon,
                isCustom: true
            });
        }
    });
    
    // Sort exercises alphabetically
    allExercises.sort((a, b) => a.name.localeCompare(b.name));
    
    // Group by muscle group
    const groupedExercises = {};
    allExercises.forEach(exercise => {
        if (!groupedExercises[exercise.muscleGroup]) {
            groupedExercises[exercise.muscleGroup] = {
                icon: exercise.muscleGroupIcon,
                exercises: []
            };
        }
        groupedExercises[exercise.muscleGroup].exercises.push(exercise);
    });
    
    // Render the list
    container.innerHTML = Object.entries(groupedExercises).map(([groupName, data]) => `
        <div style="margin-bottom: 1rem;">
            <div style="display: flex; align-items: center; margin-bottom: 0.5rem; padding: 0.5rem; background: var(--dark-lighter); border-radius: 8px;">
                <span style="font-size: 1.2rem; margin-right: 0.5rem;">${data.icon}</span>
                <h4 style="margin: 0; font-size: 0.9rem; font-weight: 600;">${groupName}</h4>
            </div>
            <div style="display: grid; gap: 0.5rem;">
                ${data.exercises.map(exercise => `
                    <button onclick="addExistingExerciseToWorkout(${exercise.id})" 
                            style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; background: var(--dark-lighter); border: 1px solid var(--border); border-radius: 8px; color: var(--text); text-align: left; cursor: pointer;">
                        <div>
                            <div style="font-weight: 600;">${exercise.name}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">MET: ${exercise.met}</div>
                        </div>
                        <div style="font-size: 1.2rem;">${exercise.isCustom ? '⭐' : '📚'}</div>
                    </button>
                `).join('')}
            </div>
        </div>
    `).join('');
}

function addExistingExerciseToWorkout(exerciseId) {
    if (!currentWorkout) {
        showToast('❌ Geen actieve workout');
        return;
    }
    
    // Find the exercise in standard exercises or custom exercises
    let exercise = null;
    
    // Check standard exercises
    for (const schema of WORKOUT_DATA.schemas) {
        for (const group of schema.muscleGroups) {
            exercise = group.exercises.find(e => e.id === exerciseId);
            if (exercise) {
                exercise = {
                    ...exercise,
                    muscleGroup: group.name,
                    muscleGroupIcon: group.icon
                };
                break;
            }
        }
        if (exercise) break;
    }
    
    // Check custom exercises if not found
    if (!exercise) {
        const customExercises = getCustomExercises();
        const customExercise = customExercises[exerciseId];
        if (customExercise) {
            // Find muscle group info
            let muscleGroup = null;
            for (const schema of WORKOUT_DATA.schemas) {
                const group = schema.muscleGroups.find(g => g.id === customExercise.muscleGroupId);
                if (group) {
                    muscleGroup = group;
                    break;
                }
            }
            
            if (muscleGroup) {
                exercise = {
                    ...customExercise,
                    muscleGroup: muscleGroup.name,
                    muscleGroupIcon: muscleGroup.icon
                };
            }
        }
    }
    
    if (!exercise) {
        showToast('❌ Oefening niet gevonden');
        return;
    }
    
    // Check if exercise is already in the workout
    const existingExercise = currentWorkout.exercises.find(e => e.id === exerciseId);
    if (existingExercise) {
        showToast('⚠️ Oefening staat al in deze workout');
        return;
    }
    
    // Add exercise to current workout
    const settings = getSettings();
    const sets = [];
    for (let i = 0; i < settings.defaultSets; i++) {
        sets.push({
            reps: 12,
            weight: getInitialWeight(exercise.id),
            completed: false
        });
    }
    
    currentWorkout.exercises.push({
        ...exercise,
        sets
    });
    
    renderExercises();
    hideInlineExerciseForm();
    showToast(`✅ Oefening '${exercise.name}' toegevoegd aan workout!`);
}

function hideInlineExerciseForm() {
    const form = document.getElementById('inlineAddExercise');
    if (form) {
        form.style.display = 'none';
        // Clear form
        document.getElementById('inlineExerciseName').value = '';
        document.getElementById('inlineMuscleGroup').value = '';
        document.getElementById('inlineExerciseMET').value = '';
    }
}

function saveInlineExercise() {
    const name = document.getElementById('inlineExerciseName').value.trim();
    const muscleGroupId = document.getElementById('inlineMuscleGroup').value;
    const met = parseFloat(document.getElementById('inlineExerciseMET').value) || 0;
    
    // Validation
    if (!name) {
        showToast('❌ Vul oefening naam in');
        return;
    }
    if (!muscleGroupId) {
        showToast('❌ Selecteer spiergroep');
        return;
    }
    if (met < 1 || met > 15) {
        showToast('❌ MET waarde moet tussen 1 en 15 zijn');
        return;
    }
    
    // Zoek spiergroep naam uit alle schemas
    let muscleGroup = null;
    for (const schema of WORKOUT_DATA.schemas) {
        const group = schema.muscleGroups.find(g => g.id === muscleGroupId);
        if (group) {
            muscleGroup = group;
            break;
        }
    }
    if (!muscleGroup) {
        showToast('❌ Spiergroep niet gevonden');
        return;
    }
    
    // Maak custom oefening aan
    const id = getNextCustomExerciseId();
    const custom = getCustomExercises();
    custom[id] = {
        id,
        name,
        met,
        muscleGroupId,
        muscleGroupName: muscleGroup.name,
        custom: true
    };
    saveCustomExercises(custom);
    
    // Als er een actieve workout is, voeg de oefening toe aan de huidige workout
    console.log('currentWorkout exists:', !!currentWorkout);
    if (currentWorkout) {
        console.log('Adding exercise to current workout');
        const settings = getSettings();
        const sets = [];
        for (let i = 0; i < settings.defaultSets; i++) {
            sets.push({
                reps: 12,
                weight: 0, // Start with 0 for custom exercises
                completed: false
            });
        }
        
        currentWorkout.exercises.push({
            id,
            name,
            met,
            muscleGroup: muscleGroup.name,
            muscleGroupIcon: muscleGroup.icon,
            sets
        });
        
        renderExercises();
        showToast(`✅ Oefening '${name}' toegevoegd aan workout!`);
    } else {
        console.log('No active workout, saving to library only');
        // Update lijst als je in oefeningen-tab zit
        const exercisesView = document.getElementById("exercisesView");
        if (exercisesView && exercisesView.style.display !== "none") {
            renderExercisesList();
        }
        showToast(`✅ Oefening '${name}' opgeslagen in bibliotheek!`);
    }
    
    hideInlineExerciseForm();
}

function closeAddExerciseModal() {
    const modal = document.getElementById('addExerciseModal');
    modal.classList.remove('active');
    // Clear form
    document.getElementById('customExerciseName').value = '';
    document.getElementById('customMuscleGroup').value = '';
    document.getElementById('customExerciseMET').value = '';
}

function saveCustomExercise() {
    const name = document.getElementById('customExerciseName').value.trim();
    const muscleGroupId = document.getElementById('customMuscleGroup').value;
    const met = parseFloat(document.getElementById('customExerciseMET').value) || 0;
    
    console.log('Form values:', { name, muscleGroupId, met });
    
    // Validation
    if (!name) {
        showToast('❌ Vul oefening naam in');
        return;
    }
    if (!muscleGroupId) {
        showToast('❌ Selecteer spiergroep');
        return;
    }
    if (met < 1 || met > 15) {
        showToast('❌ MET waarde moet tussen 1 en 15 zijn');
        return;
    }
    
    // Zoek spiergroep naam uit alle schemas
    let muscleGroup = null;
    for (const schema of WORKOUT_DATA.schemas) {
        const group = schema.muscleGroups.find(g => g.id === muscleGroupId);
        if (group) {
            muscleGroup = group;
            break;
        }
    }
    if (!muscleGroup) {
        showToast('❌ Spiergroep niet gevonden');
        return;
    }
    // Maak custom oefening aan
    const id = getNextCustomExerciseId();
    const custom = getCustomExercises();
    custom[id] = {
        id,
        name,
        met,
        muscleGroupId,
        muscleGroupName: muscleGroup.name,
        custom: true
    };
    saveCustomExercises(custom);
    
    // Als er een actieve workout is, voeg de oefening toe aan de huidige workout
    console.log('currentWorkout exists:', !!currentWorkout);
    if (currentWorkout) {
        console.log('Adding exercise to current workout');
        const settings = getSettings();
        const sets = [];
        for (let i = 0; i < settings.defaultSets; i++) {
            sets.push({
                reps: 12,
                weight: 0, // Start with 0 for custom exercises
                completed: false
            });
        }
        
        currentWorkout.exercises.push({
            id,
            name,
            met,
            muscleGroup: muscleGroup.name,
            muscleGroupIcon: muscleGroup.icon,
            sets
        });
        
        renderExercises();
        showToast(`✅ Oefening '${name}' toegevoegd aan workout!`);
    } else {
        console.log('No active workout, saving to library only');
        // Update lijst als je in oefeningen-tab zit
        const exercisesView = document.getElementById("exercisesView");
        if (exercisesView && exercisesView.style.display !== "none") {
            renderExercisesList();
        }
        showToast(`✅ Oefening '${name}' opgeslagen in bibliotheek!`);
    }
    
    closeAddExerciseModal();

}

// App initialisatie
function init() {
    loadTheme();
    setAppVersionLabel();
    renderSchemaSelection();
    loadSettings();
    // Normalize historical data to canonical exercise ids/names
    migrateNormalizeExercises();
    migrateHackSquatToHackSquadToday();
    migratePRsHackSquatToHackSquad();
    migrateUnifyHackSquadIds();
    renderHistory();
    renderPRs();
}

document.addEventListener("DOMContentLoaded", init);

function setAppVersionLabel() {
    try {
        const el = document.getElementById("appVersionText");
        if (el) el.textContent = APP_VERSION;
    } catch (e) {}
}

function forceReload() {
    try {
        const base = location.href.split("?")[0];
        const newUrl = `${base}?v=${APP_VERSION}&t=${Date.now()}`;
        localStorage.setItem("app_version", APP_VERSION);
        location.replace(newUrl);
    } catch (e) {
        location.reload();
    }
}

function renderSchemaSelection() {
    const container = document.getElementById("schemaSelection");
    container.innerHTML = WORKOUT_DATA.schemas.map(schema => {
        const totalExercises = schema.muscleGroups.reduce((sum, g) => sum + g.exercises.length, 0);
        const classType = schema.id === "schema1" ? "push" : schema.id === "schema2" ? "legs" : "custom";
        const badgeText = schema.id === "schema1" ? "Upper" : schema.id === "schema2" ? "Lower" : "Custom";
        const { accent, accent2 } = getSchemaAccentPair(schema.color);
        const styleVars = `--schema-accent:${accent}; --schema-accent-2:${accent2};`;
        
        return `
            <div class="schema-card ${classType}" onclick="selectSchema('${schema.id}')" style="${styleVars}">
                <div class="schema-content">
                    <div class="schema-header">
                        <div class="schema-icon">${schema.icon}</div>
                        <div class="schema-badge">${badgeText}</div>
                    </div>
                    <h3>${schema.name}</h3>
                    <p>${schema.description}</p>
                    <div class="schema-stats">
                        <div class="schema-stat">
                            <span class="schema-stat-value">${schema.muscleGroups.length}</span>
                            <span class="schema-stat-label">Groepen</span>
                        </div>
                        <div class="schema-stat">
                            <span class="schema-stat-value">${totalExercises}</span>
                            <span class="schema-stat-label">Oefeningen</span>
                        </div>
                        <div class="schema-stat">
                            <span class="schema-stat-value">${totalExercises * 3}</span>
                            <span class="schema-stat-label">Sets</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join("");
}

function selectSchema(schemaId) {
    const schema = WORKOUT_DATA.schemas.find(s => s.id === schemaId);
    if (!schema) return;
    
    const settings = getSettings();
    
    currentWorkout = {
        schemaId: schema.id,
        schemaName: schema.name,
        startTime: new Date().toISOString(),
        exercises: []
    };
    
    schema.muscleGroups.forEach(group => {
        group.exercises.forEach(exercise => {
            const sets = [];
            for (let i = 0; i < settings.defaultSets; i++) {
                sets.push({
                    reps: 12,
                    weight: getInitialWeight(exercise.id),
                    completed: false
                });
            }
            
            currentWorkout.exercises.push({
                ...exercise,
                muscleGroup: group.name,
                muscleGroupIcon: group.icon,
                sets
            });
        });
    });
    
    document.getElementById("schemaSelection").style.display = "none";
    document.getElementById("activeWorkout").style.display = "block";
    document.getElementById("bottomActions").classList.add("active");
    document.getElementById("fabAddExercise").classList.add("visible");
    
    // Update timer card color based on schema
    const timerCard = document.getElementById("timerCard");
    const { accent, accent2 } = getSchemaAccentPair(schema.color);
    timerCard.style.setProperty("--schema-accent", accent);
    timerCard.style.setProperty("--schema-accent-2", accent2);
    
    renderExercises();
    startTimer();
}

function renderExercises() {
    if (!currentWorkout) return;
    updateExerciseMeta();
    updateStats();
    
    const container = document.getElementById("exercisesContainer");
    const visibleExercises = currentWorkout.exercises.filter(ex => !ex.sets.every(s => s.completed));

    // Default: only the first visible exercise expanded, others collapsed unless user toggled
    visibleExercises.forEach((ex, idx) => {
        if (collapsedExercises[ex.id] === undefined) {
            collapsedExercises[ex.id] = idx === 0 ? false : true;
        }
    });

    if (visibleExercises.length === 0) {
        container.innerHTML = `
            <div class="empty-state" style="margin-top:1rem;">
                <div class="empty-state-icon"></div>
                <h3>Alle oefeningen voltooid</h3>
                <p>Top! Voltooi de workout of voeg een set toe als je wilt doorgaan.</p>
            </div>
        `;
        return;
    }

    const groupedExercises = {};
    
    visibleExercises.forEach(ex => {
        if (!groupedExercises[ex.muscleGroup]) {
            groupedExercises[ex.muscleGroup] = {
                icon: ex.muscleGroupIcon,
                exercises: []
            };
        }
        groupedExercises[ex.muscleGroup].exercises.push(ex);
    });
    
    container.innerHTML = Object.entries(groupedExercises).map(([groupName, data]) => {
        const completed = data.exercises.filter(ex => ex.sets.some(s => s.completed)).length;
        const total = data.exercises.length;
        
        return `
            <div class="muscle-group">
                <div class="muscle-group-header">
                    <div class="muscle-group-title">
                        <span class="muscle-group-icon">${data.icon}</span>
                        <h3>${groupName}</h3>
                    </div>
                    <div class="progress-badge">${completed}/${total}</div>
                </div>
                ${data.exercises.map(ex => renderExerciseCard(ex)).join("")}
            </div>
        `;
    }).join("");
}

function updateExerciseMeta() {
    const el = document.getElementById("exerciseMeta");
    if (!el) return;
    if (!currentWorkout) {
        el.textContent = "Oefeningen: 0/0";
        return;
    }
    const total = currentWorkout.exercises.length;
    const completed = currentWorkout.exercises.filter(ex => ex.sets.every(s => s.completed)).length;
    el.textContent = `Oefeningen: ${completed}/${total}`;
}

function renderExerciseCard(exercise) {
    const previousBest = getPreviousBest(exercise.id);
    const hasPR = checkIfPR(exercise);
    const collapsed = collapsedExercises[exercise.id];
    const setsDisplay = collapsed ? 'style="display:none;"' : '';
    const collapseClass = collapsed ? 'collapse-btn collapsed' : 'collapse-btn';
    
    return `
        <div class="exercise-card">
            <div class="exercise-header">
                <div class="exercise-title">
                    <div class="exercise-name">
                        ${exercise.name}
                        ${hasPR ? '<span class="pr-badge-inline"> PR!</span>' : ""}
                    </div>
                    <div class="exercise-meta">
                        <span class="exercise-meta-item"> MET ${exercise.met.toFixed(1)}</span>
                        ${previousBest ? `<span class="exercise-meta-item"> Best: ${previousBest.weight}kg × ${previousBest.reps}</span>` : ""}
                    </div>
                </div>
                <div class="exercise-actions">
                    <button class="exercise-btn ${collapseClass}" onclick="toggleExercise(${exercise.id})" title="Toon/Verberg sets" aria-label="Toon/Verberg sets"></button>
                    <button class="exercise-btn progress-btn" onclick="openExerciseProgress(${exercise.id})" title="Bekijk progressie" aria-label="Bekijk progressie"></button>
                </div>
            </div>
            <div class="sets-container" id="sets-${exercise.id}" ${setsDisplay}>
                ${previousBest ? `
                    <div class="previous-best">
                        <span class="previous-best-label"> Vorige Beste</span>
                        <span class="previous-best-value">${previousBest.weight}kg × ${previousBest.reps} reps</span>
                    </div>
                ` : ""}
                ${exercise.sets.map((set, idx) => `
                    <div class="set-row ${set.completed ? "completed" : ""}">
                        <div class="set-input-group">
                            <div style="display:flex; align-items:center; gap:0.5rem;">
                                <button class="btn btn-secondary" style="padding:0.4rem 0.6rem" onclick="adjustSet(${exercise.id}, ${idx}, 'reps', -1)">−</button>
                                <input 
                                    type="number" 
                                    class="set-input" 
                                    placeholder="12" 
                                    value="${set.reps ?? 12}"
                                    onchange="updateSet(${exercise.id}, ${idx}, 'reps', this.value)"
                                    min="0"
                                    max="100"
                                    step="1"
                                >
                                <button class="btn btn-secondary" style="padding:0.4rem 0.6rem" onclick="adjustSet(${exercise.id}, ${idx}, 'reps', 1)">+</button>
                            </div>
                            <div class="set-input-label">Reps</div>
                        </div>
                        <div class="set-input-group">
                            <div style="display:flex; align-items:center; gap:0.5rem;">
                                <button class="btn btn-secondary" style="padding:0.4rem 0.6rem" onclick="adjustSet(${exercise.id}, ${idx}, 'weight', -1)">−</button>
                                <input 
                                    type="number" 
                                    class="set-input" 
                                    placeholder="0" 
                                    value="${set.weight ?? getLastWeight(exercise.id) ?? 0}"
                                    onchange="updateSet(${exercise.id}, ${idx}, 'weight', this.value)"
                                    min="0"
                                    max="500"
                                    step="1"
                                    inputmode="numeric"
                                >
                                <button class="btn btn-secondary" style="padding:0.4rem 0.6rem" onclick="adjustSet(${exercise.id}, ${idx}, 'weight', 1)">+</button>
                            </div>
                            <div class="set-input-label">KG</div>
                        </div>
                        <div 
                            class="checkbox ${set.completed ? "checked" : ""}"
                            onclick="toggleSet(${exercise.id}, ${idx})"
                        ></div>
                    </div>
                `).join("")}
            </div>
        </div>
    `;
}

function updateSet(exerciseId, setIndex, field, value) {
    const exercise = currentWorkout.exercises.find(ex => ex.id === exerciseId);
    if (!exercise) return;
    
    const num = parseFloat(value);
    exercise.sets[setIndex][field] = isNaN(num) ? 0 : num;
    if (field === 'weight') {
        saveLastWeight(exerciseId, exercise.sets[setIndex].weight);
    }
    updateStats();
    
    // Check for PR
    if (field === "weight" && exercise.sets[setIndex].completed) {
        checkAndShowPR(exercise, setIndex);
    }
}

function toggleSet(exerciseId, setIndex) {
    const exercise = currentWorkout.exercises.find(ex => ex.id === exerciseId);
    if (!exercise) return;
    
    const set = exercise.sets[setIndex];

    if (!set.completed && (!set.reps || !set.weight)) {
        showToast("Vul eerst reps en gewicht in", "error");
        return;
    }

    const wasCompleted = set.completed;
    set.completed = !set.completed;

    if (set.completed && !wasCompleted) {
        startRestTimer();
        checkAndShowPR(exercise, setIndex);
        focusOnTimer();

        // If this exercise is now fully complete, auto-open the next incomplete exercise
        const isExerciseDone = exercise.sets.every(s => s.completed);
        if (isExerciseDone) {
            const exIndex = currentWorkout.exercises.findIndex(ex => ex.id === exerciseId);
            const next = currentWorkout.exercises.slice(exIndex + 1).find(ex => !ex.sets.every(s => s.completed));
            if (next) {
                collapsedExercises[next.id] = false;
            }
        }
    }
    
    renderExercises();
    updateStats();
}

function toggleExercise(exerciseId) {
    const el = document.getElementById(`sets-${exerciseId}`);
    if (!el) return;
    const isHidden = el.style.display === 'none';
    const nextHidden = !isHidden;
    el.style.display = nextHidden ? 'none' : 'grid';
    collapsedExercises[exerciseId] = nextHidden;
    const card = el.closest('.exercise-card');
    if (card) {
        const btn = card.querySelector('.exercise-btn.collapse-btn');
        if (btn) btn.classList.toggle('collapsed', nextHidden);
    }
}

function openExerciseProgress(exerciseId) {
    // switch to progress view and set exercise selection
    const history = getWorkoutHistory();
    // find schema and exercise names
    let targetSchemaId = null;
    let exerciseName = null;
    history.some(w => {
        const ex = w.exercises.find(e => e.id === exerciseId);
        if (ex) {
            targetSchemaId = w.schemaId;
            exerciseName = ex.name;
            return true;
        }
        return false;
    });
    if (!targetSchemaId) {
        showToast("Geen progressiedata voor deze oefening", "error");
        return;
    }
    progressState.schemaId = targetSchemaId;
    progressState.exerciseId = exerciseId;
    switchView('progress');
    // update the dropdowns if they exist after render
    setTimeout(() => {
        const schemaSelect = document.getElementById('progressSchemaSelect');
        const exSelect = document.getElementById('progressExerciseSelect');
        if (schemaSelect) schemaSelect.value = targetSchemaId;
        if (exSelect) exSelect.value = exerciseId;
        updateProgressChart();
        addBackToWorkoutButton();
    }, 120);
}

function addBackToWorkoutButton() {
    const container = document.getElementById('progressContainer');
    if (!container) return;
    let backBtn = document.getElementById('backToWorkoutBtn');
    if (!backBtn) {
        backBtn = document.createElement('button');
        backBtn.id = 'backToWorkoutBtn';
        backBtn.className = 'btn btn-secondary';
        backBtn.style.marginTop = '1rem';
        backBtn.textContent = '← Terug naar workout';
        backBtn.onclick = () => switchView('workout');
        container.appendChild(backBtn);
    }
}

function focusOnTimer() {
    const timerCard = document.getElementById("timerCard");
    if (timerCard) {
        timerCard.scrollIntoView({ behavior: "smooth", block: "start" });
    }
}

function addSet(exerciseId) {
    const exercise = currentWorkout.exercises.find(ex => ex.id === exerciseId);
    if (!exercise) return;
    
    exercise.sets.push({
        reps: 12,
        weight: getInitialWeight(exerciseId),
        completed: false
    });
    
    renderExercises();
}

function removeSet(exerciseId) {
    const exercise = currentWorkout.exercises.find(ex => ex.id === exerciseId);
    if (!exercise || exercise.sets.length <= 1) return;
    
    exercise.sets.pop();
    renderExercises();
    updateStats();
}

function updateStats() {
    if (!currentWorkout) return;
    
    let totalSets = 0;
    let totalVolume = 0;
    
    currentWorkout.exercises.forEach(ex => {
        ex.sets.forEach(set => {
            if (set.completed) {
                totalSets++;
                totalVolume += (set.weight * set.reps);
            }
        });
    });
    
    const settings = getSettings();
    const durationMinutes = timerSeconds / 60;
    const totalKcal = calculateKcal(totalVolume, durationMinutes, settings.bodyWeight);
    
    const statSetsEl = document.getElementById("statSets");
    if (statSetsEl) statSetsEl.textContent = totalSets;
    const statVolumeEl = document.getElementById("statVolume");
    if (statVolumeEl) statVolumeEl.textContent = totalVolume.toFixed(0);
    const statKcalEl = document.getElementById("statKcal");
    if (statKcalEl) statKcalEl.textContent = totalKcal.toFixed(0);
}

function calculateKcal(volume, durationMinutes, bodyWeight) {
    const met = 5.0;
    return (met * bodyWeight * (durationMinutes / 60)) * 1.2;
}

// SET ADJUST HELPERS & LAST WEIGHT PERSISTENCE
function adjustSet(exerciseId, setIndex, field, delta) {
    const exercise = currentWorkout?.exercises.find(ex => ex.id === exerciseId);
    if (!exercise) return;
    const set = exercise.sets[setIndex];
    if (field === 'reps') {
        const next = Math.max(0, Math.min(100, (parseInt(set.reps || 0) + delta)));
        set.reps = next;
    } else if (field === 'weight') {
        const next = Math.max(0, Math.min(500, (parseInt(set.weight || 0) + delta)));
        set.weight = next;
        saveLastWeight(exerciseId, next);
    }
    renderExercises();
    updateStats();
}

function saveLastWeight(exerciseId, weight) {
    try {
        localStorage.setItem(`last_weight_${exerciseId}`, JSON.stringify(weight));
    } catch (e) {}
}

function getLastWeight(exerciseId) {
    try {
        const v = localStorage.getItem(`last_weight_${exerciseId}`);
        return v ? JSON.parse(v) : 0;
    } catch (e) { return 0; }
}

function getInitialWeight(exerciseId) {
    const last = getLastWeight(exerciseId);
    if (last && last > 0) return last;
    const prev = getPreviousBest(exerciseId);
    return prev ? prev.weight : 0;
}

// TIMER
function startTimer() {
    if (timerRunning) return;
    timerRunning = true;
    document.getElementById("timerCard").classList.add("running");
    document.getElementById("timerIcon").textContent = "";
    document.getElementById("timerText").textContent = "Pause";
    
    timerInterval = setInterval(() => {
        timerSeconds++;
        updateTimerDisplay();
        updateStats();
    }, 1000);
}

function toggleTimer() {
    if (timerRunning) {
        pauseTimer();
    } else {
        resumeTimer();
    }
}

function pauseTimer() {
    timerRunning = false;
    clearInterval(timerInterval);
    document.getElementById("timerCard").classList.remove("running");
    document.getElementById("timerIcon").textContent = "";
    document.getElementById("timerText").textContent = "Hervatten";
}

function resumeTimer() {
    startTimer();
}

function resetTimer() {
    if (!confirm("Timer resetten? Je workout blijft bewaard.")) return;
    
    pauseTimer();
    timerSeconds = 0;
    updateTimerDisplay();
}

function updateTimerDisplay() {
    const hours = Math.floor(timerSeconds / 3600);
    const minutes = Math.floor((timerSeconds % 3600) / 60);
    const seconds = timerSeconds % 60;
    
    const display = hours > 0
        ? `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`
        : `${pad(minutes)}:${pad(seconds)}`;
    
    document.getElementById("timer").textContent = display;
}

// REST TIMER
function startRestTimer(seconds = REST_DURATION_SECONDS) {
    stopRestTimer(true);
    restTimerRemaining = seconds;
    updateRestTimerUI();
    const card = document.getElementById("restTimerCard");
    if (card) card.style.display = "block";
    restTimerInterval = setInterval(() => {
        restTimerRemaining = Math.max(0, restTimerRemaining - 1);
        updateRestTimerUI();
        if (restTimerRemaining <= 0) {
            stopRestTimer(true);
        }
    }, 1000);
}

function refreshRestTimer() {
    startRestTimer(REST_DURATION_SECONDS);
}

function stopRestTimer(auto = false) {
    if (restTimerInterval) {
        clearInterval(restTimerInterval);
        restTimerInterval = null;
    }
    if (!auto) {
        restTimerRemaining = 0;
        const card = document.getElementById("restTimerCard");
        if (card) card.style.display = "none";
    }
    updateRestTimerUI();
}

function updateRestTimerUI() {
    const progress = document.getElementById("restTimerProgress");
    const label = document.getElementById("restTimerLabel");
    const card = document.getElementById("restTimerCard");
    if (!progress || !label || !card) return;
    const remaining = Math.max(0, restTimerRemaining || 0);
    const pct = Math.max(0, Math.min(100, (remaining / REST_DURATION_SECONDS) * 100));
    progress.style.width = `${pct}%`;
    const m = Math.floor(remaining / 60);
    const s = remaining % 60;
    label.textContent = `Rust: ${m}:${s.toString().padStart(2, '0')}`;
    if (remaining === 0 && !restTimerInterval) {
        card.style.display = "none";
    }
}

function pad(num) {
    return num.toString().padStart(2, "0");
}

// WORKOUT COMPLETION
function finishWorkout() {
    if (!currentWorkout) return;
    
    const completedSets = currentWorkout.exercises.reduce((sum, ex) => {
        return sum + ex.sets.filter(s => s.completed).length;
    }, 0);
    
    if (completedSets === 0) {
        if (!confirm("Je hebt geen sets voltooid. Toch afsluiten?")) return;
    }
    
    pauseTimer();
    
    currentWorkout.endTime = new Date().toISOString();
    currentWorkout.duration = timerSeconds;
    
    // Save workout
    saveWorkout(currentWorkout);
    
    // Update PRs
    updatePRs(currentWorkout);
    
    showToast(`Workout voltooid! ${completedSets} sets in ${formatDuration(timerSeconds)}`, "success");
    
    // Reset
    resetWorkout();
}

function cancelWorkout() {
    if (!confirm("Workout annuleren? Je voortgang gaat verloren.")) return;
    
    pauseTimer();
    resetWorkout();
}

function resetWorkout() {
    currentWorkout = null;
    timerSeconds = 0;
    timerRunning = false;
    clearInterval(timerInterval);
    
    document.getElementById("schemaSelection").style.display = "grid";
    document.getElementById("activeWorkout").style.display = "none";
    document.getElementById("bottomActions").classList.remove("active");
    document.getElementById("timerCard").classList.remove("running");
    document.getElementById("fabAddExercise").classList.remove("visible");
    hideInlineExerciseForm();
    closeAddExerciseModal();
    
    updateTimerDisplay();
    updateStats();
    updateExerciseMeta();
    renderHistory();
    renderPRs();
}

// WORKOUT STORAGE
function saveWorkout(workout) {
    const history = getWorkoutHistory();
    history.unshift(workout);
    
    // Keep last 100 workouts
    if (history.length > 100) {
        history.splice(100);
    }
    
    localStorage.setItem("workout_history", JSON.stringify(history));
}

function getWorkoutHistory() {
    const stored = localStorage.getItem("workout_history");
    return stored ? JSON.parse(stored) : [];
}

// DATA MIGRATION: Move today's "Hack Squat" entries to "Hack Squad"
function migrateHackSquatToHackSquadToday() {
    try {
        const history = getWorkoutHistory();
        if (!Array.isArray(history) || history.length === 0) return;
        const todayStr = new Date().toDateString();
        let changed = false;
        history.forEach(w => {
            const d = new Date(w.startTime).toDateString();
            if (d !== todayStr || !Array.isArray(w.exercises)) return;
            w.exercises.forEach(ex => {
                if (ex && typeof ex.name === 'string' && ex.name.trim().toLowerCase() === 'hack squat') {
                    ex.name = 'Hack Squad';
                    // keep id if present, otherwise set to 111
                    if (!ex.id) ex.id = 111;
                    changed = true;
                }
            });
        });
        if (changed) {
            localStorage.setItem('workout_history', JSON.stringify(history));
        }
    } catch (e) { /* ignore */ }
}

function deleteWorkout(index) {
    if (!confirm('Weet je zeker dat je deze workout wilt verwijderen?')) {
        return;
    }
    
    const history = getWorkoutHistory();
    if (index < 0 || index >= history.length) return;
    
    history.splice(index, 1);
    localStorage.setItem("workout_history", JSON.stringify(history));
    
    showToast("Workout verwijderd", "success");
    renderHistory();
    renderPRs();
}

// PR TRACKING
function getPRs() {
    const stored = localStorage.getItem("workout_prs");
    return stored ? JSON.parse(stored) : {};
}

// DATA MIGRATION: General normalization of exercises in history and PRs
function migrateNormalizeExercises() {
    try {
        // Build canonical maps from WORKOUT_DATA
        const canonicalById = {};
        const canonicalByName = {};
        WORKOUT_DATA.schemas.forEach(s => {
            s.muscleGroups.forEach(g => {
                g.exercises.forEach(ex => {
                    canonicalById[ex.id] = ex.name;
                    const key = ex.name.trim().toLowerCase();
                    canonicalByName[key] = { id: ex.id, name: ex.name };
                });
            });
        });
        // Known synonyms (left lowercased) → canonical id
        const synonyms = {
            "hack squat": 111,
            "hack squad": 111
        };
        Object.keys(synonyms).forEach(n => {
            const id = synonyms[n];
            if (canonicalById[id]) {
                canonicalByName[n] = { id, name: canonicalById[id] };
            }
        });

        // Normalize workout history
        let history = getWorkoutHistory();
        let histChanged = false;
        history.forEach(w => {
            if (!Array.isArray(w.exercises)) return;
            w.exercises.forEach(ex => {
                if (!ex) return;
                // Prefer id mapping if valid
                if (ex.id && canonicalById[ex.id]) {
                    ex.name = canonicalById[ex.id];
                    return;
                }
                // Else try name mapping
                const key = (ex.name || '').toString().trim().toLowerCase();
                const canon = canonicalByName[key];
                if (canon) {
                    if (ex.id !== canon.id || ex.name !== canon.name) {
                        ex.id = canon.id;
                        ex.name = canon.name;
                        histChanged = true;
                    }
                }
            });
        });
        if (histChanged) {
            localStorage.setItem('workout_history', JSON.stringify(history));
        }

        // Normalize and merge PRs by canonical id
        const prs = getPRs();
        if (prs && typeof prs === 'object') {
            const merged = {};
            Object.keys(prs).forEach(key => {
                const pr = prs[key];
                if (!pr) return;
                let targetId = pr.exerciseId;
                let targetName = pr.exerciseName;
                if (targetId && canonicalById[targetId]) {
                    targetName = canonicalById[targetId];
                } else {
                    const nk = (pr.exerciseName || '').toString().trim().toLowerCase();
                    const canon = canonicalByName[nk];
                    if (canon) {
                        targetId = canon.id;
                        targetName = canon.name;
                    }
                }
                if (!targetId) return; // skip unknowns
                const newKey = String(targetId);
                const next = { ...pr, exerciseId: targetId, exerciseName: targetName };
                const cur = merged[newKey];
                if (!cur || (next.oneRM || 0) > (cur.oneRM || 0)) {
                    merged[newKey] = next;
                }
            });
            localStorage.setItem('workout_prs', JSON.stringify(merged));
        }
    } catch (e) { /* ignore */ }
}

// DATA MIGRATION: Rename PR entries from "Hack Squat" to "Hack Squad"
function migratePRsHackSquatToHackSquad() {
    try {
        const prs = getPRs();
        if (!prs || typeof prs !== 'object') return;
        let changed = false;
        Object.keys(prs).forEach(key => {
            const pr = prs[key];
            if (!pr || typeof pr.exerciseName !== 'string') return;
            if (pr.exerciseName.trim().toLowerCase() === 'hack squat') {
                pr.exerciseName = 'Hack Squad';
                if (!pr.exerciseId) pr.exerciseId = 111;
                changed = true;
            }
        });
        if (changed) {
            localStorage.setItem('workout_prs', JSON.stringify(prs));
        }
    } catch (e) { /* ignore */ }
}

// DATA MIGRATION: Unify all history exercises named Hack Squat/Squad to id=111, name="Hack Squad"
function migrateUnifyHackSquadIds() {
    try {
        const history = getWorkoutHistory();
        if (!Array.isArray(history) || history.length === 0) return;
        let changed = false;
        history.forEach(w => {
            if (!Array.isArray(w.exercises)) return;
            w.exercises.forEach(ex => {
                if (!ex || typeof ex.name !== 'string') return;
                const nm = ex.name.trim().toLowerCase();
                if (nm === 'hack squat' || nm === 'hack squad') {
                    if (ex.id !== 111 || ex.name !== 'Hack Squad') {
                        ex.id = 111;
                        ex.name = 'Hack Squad';
                        changed = true;
                    }
                }
            });
        });
        if (changed) {
            localStorage.setItem('workout_history', JSON.stringify(history));
        }

        // Also merge PRs under key 111 to ensure previous best is consistent
        const prs = getPRs();
        if (prs && typeof prs === 'object') {
            let newPrs = {};
            let merged = false;
            Object.keys(prs).forEach(key => {
                const pr = prs[key];
                if (!pr) return;
                const nm = (pr.exerciseName || '').toString().trim().toLowerCase();
                if (nm === 'hack squat' || nm === 'hack squad' || pr.exerciseId === 111) {
                    const unified = {
                        ...pr,
                        exerciseId: 111,
                        exerciseName: 'Hack Squad'
                    };
                    const existing = newPrs['111'];
                    if (!existing || (unified.oneRM || 0) > (existing.oneRM || 0)) {
                        newPrs['111'] = unified;
                    }
                    merged = true;
                } else {
                    newPrs[key] = pr;
                }
            });
            if (merged) {
                localStorage.setItem('workout_prs', JSON.stringify(newPrs));
            }
        }
    } catch (e) { /* ignore */ }
}

function updatePRs(workout) {
    const prs = getPRs();
    let newPRs = [];
    
    workout.exercises.forEach(exercise => {
        exercise.sets.forEach(set => {
            if (!set.completed) return;
            
            const key = exercise.id.toString();
            const currentPR = prs[key];
            
            const oneRM = calculateOneRM(set.weight, set.reps);
            
            if (!currentPR || oneRM > currentPR.oneRM) {
                prs[key] = {
                    exerciseId: exercise.id,
                    exerciseName: exercise.name,
                    weight: set.weight,
                    reps: set.reps,
                    oneRM: oneRM,
                    date: new Date().toISOString()
                };
                newPRs.push(prs[key]);
            }
        });
    });
    
    localStorage.setItem("workout_prs", JSON.stringify(prs));
    
    return newPRs;
}

function calculateOneRM(weight, reps) {
    if (reps === 1) return weight;
    return weight * (1 + reps / 30);
}

function getPreviousBest(exerciseId) {
    const prs = getPRs();
    return prs[exerciseId.toString()];
}

function checkIfPR(exercise) {
    const previousBest = getPreviousBest(exercise.id);
    if (!previousBest) return false;
    
    return exercise.sets.some(set => {
        if (!set.completed) return false;
        const oneRM = calculateOneRM(set.weight, set.reps);
        return oneRM > previousBest.oneRM;
    });
}

function checkAndShowPR(exercise, setIndex) {
    const set = exercise.sets[setIndex];
    if (!set.completed) return;
    
    const previousBest = getPreviousBest(exercise.id);
    const oneRM = calculateOneRM(set.weight, set.reps);
    
    if (!previousBest || oneRM > previousBest.oneRM) {
        setTimeout(() => {
            showPRCelebration(exercise.name, set.weight, set.reps, previousBest);
        }, 300);
    }
}

function showPRCelebration(exerciseName, weight, reps, previousBest) {
    document.getElementById("prDetail").textContent = `${exerciseName}: ${weight}kg × ${reps} reps`;
    
    if (previousBest) {
        const improvement = ((calculateOneRM(weight, reps) / previousBest.oneRM - 1) * 100).toFixed(1);
        document.getElementById("prSub").textContent = `+${improvement}% sterker dan je vorige PR!`;
    } else {
        document.getElementById("prSub").textContent = "Je eerste PR voor deze oefening!";
    }
    
    document.getElementById("prCelebration").classList.add("active");
}

function closePRCelebration() {
    document.getElementById("prCelebration").classList.remove("active");
}

// HISTORY RENDERING
function renderHistory() {
    renderCalendar();
    renderHistoryList();
}

function renderCalendar() {
    const container = document.getElementById('calendarContainer');
    if (!container) return;
    
    const today = new Date();
    const year = currentCalendarYear || today.getFullYear();
    const month = currentCalendarMonth !== undefined ? currentCalendarMonth : today.getMonth();
    
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    
    // Start from Monday before first day
    const startDate = new Date(firstDay);
    const dayOfWeek = firstDay.getDay();
    const daysToSubtract = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
    startDate.setDate(startDate.getDate() - daysToSubtract);
    
    const history = getWorkoutHistory();
    const workoutsByDate = {};
    
    history.forEach(w => {
        const date = new Date(w.startTime).toDateString();
        if (!workoutsByDate[date]) workoutsByDate[date] = [];
        workoutsByDate[date].push(w);
    });
    
    let html = `
        <div class="calendar-header">
            <button class="calendar-nav-btn" onclick="previousMonth()">◀</button>
            <div class="calendar-month-year">${firstDay.toLocaleDateString('nl-NL', { month: 'long', year: 'numeric' })}</div>
            <button class="calendar-nav-btn" onclick="nextMonth()">▶</button>
        </div>
        <div class="calendar-grid">
            <div class="calendar-weekday">Ma</div>
            <div class="calendar-weekday">Di</div>
            <div class="calendar-weekday">Wo</div>
            <div class="calendar-weekday">Do</div>
            <div class="calendar-weekday">Vr</div>
            <div class="calendar-weekday">Za</div>
            <div class="calendar-weekday">Zo</div>
    `;
    
    const currentDate = new Date(startDate);
    const today_str = today.toDateString();
    
    // Render 6 weeks (42 days)
    for (let i = 0; i < 42; i++) {
        const dateStr = currentDate.toDateString();
        const hasWorkout = workoutsByDate[dateStr] ? true : false;
        const isToday = dateStr === today_str;
        const isOtherMonth = currentDate.getMonth() !== month;
        let dayStyle = "";
        if (hasWorkout && !isOtherMonth) {
            const schemaId = workoutsByDate[dateStr][0].schemaId;
            const accent = getSchemaColor(schemaId);
            const border = shadeColor(accent, -14);
            const shadow = hexToRgba(accent, 0.35);
            dayStyle = `style="background:${accent}; color:#000; border:1px solid ${border}; box-shadow:0 0 12px ${shadow};"`;
        }
        
        const classes = [
            'calendar-day',
            hasWorkout && !isOtherMonth ? 'has-workout' : '',
            isToday ? 'today' : '',
            isOtherMonth ? 'other-month' : ''
        ].filter(c => c).join(' ');
        
        html += `<div class="${classes}" ${dayStyle} onclick="selectCalendarDay('${dateStr}')">${currentDate.getDate()}</div>`;
        
        currentDate.setDate(currentDate.getDate() + 1);
    }
    
    html += '</div>';
    
    container.innerHTML = html;
}

let currentCalendarMonth = new Date().getMonth();
let currentCalendarYear = new Date().getFullYear();

function previousMonth() {
    currentCalendarMonth--;
    if (currentCalendarMonth < 0) {
        currentCalendarMonth = 11;
        currentCalendarYear--;
    }
    renderCalendar();
}

function nextMonth() {
    currentCalendarMonth++;
    if (currentCalendarMonth > 11) {
        currentCalendarMonth = 0;
        currentCalendarYear++;
    }
    renderCalendar();
}

function selectCalendarDay(dateStr) {
    const history = getWorkoutHistory();
    const dayWorkouts = history.filter(w => {
        const workoutDate = new Date(w.startTime);
        return workoutDate.toDateString() === dateStr;
    });
    
    if (dayWorkouts.length === 0) return;
    
    const historyContainer = document.getElementById('historyContainer');
    
    let html = `
        <div class="calendar-workouts" id="calendarWorkouts">
            <div class="calendar-workouts-title">${new Date(dateStr).toLocaleDateString('nl-NL', { weekday: 'long', day: 'numeric', month: 'long' })}</div>
    `;
    
    dayWorkouts.forEach((workout, idx) => {
        const completedSets = workout.exercises.reduce((sum, ex) => sum + ex.sets.filter(s => s.completed).length, 0);
        const totalVolume = workout.exercises.reduce((sum, ex) => sum + ex.sets.reduce((s, set) => set.completed ? s + (set.weight * set.reps) : s, 0), 0);
        
        // Find the global index of this workout in full history
        const allHistory = getWorkoutHistory();
        const globalIdx = allHistory.findIndex(w => w.startTime === workout.startTime && w.schemaName === workout.schemaName);
        
        html += `
            <div class="calendar-workout-item">
                <div style="display:flex; justify-content:space-between; margin-bottom:0.5rem; align-items:center;">
                    <strong>${workout.schemaName}</strong>
                    <div style="display:flex; gap:0.5rem; align-items:center;">
                        <span style="font-size:0.85rem; color:var(--text-muted);">${formatDuration(workout.duration)}</span>
                        <button class="btn-icon delete-btn" onclick="deleteWorkout(${globalIdx})" title="Verwijderen">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 6h18M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2m3 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6h14M10 11v6m4-6v6"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div style="font-size:0.85rem; color:var(--text-muted); margin-bottom:0.75rem;">
                    ${completedSets} sets • ${totalVolume.toFixed(0)} kg
                </div>
                <button class="btn btn-secondary" style="width:100%; padding:0.5rem; font-size:0.9rem;" onclick="expandWorkoutDetails(${idx}, '${dateStr}')">
                    Oefeningen tonen
                </button>
            </div>
            <div id="workout-details-${idx}" style="display:none; margin-top:0.5rem; padding:0.75rem; background:var(--dark-elevated); border-radius:12px;"></div>
        `;
    });
    
    html += '</div>';
    historyContainer.innerHTML = html;
    // Smooth scroll the workouts block into view
    setTimeout(() => {
        const listEl = document.getElementById('calendarWorkouts');
        if (listEl) {
            listEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }, 0);
    window.selectedDayWorkouts = dayWorkouts;
}

function expandWorkoutDetails(workoutIdx, dateStr) {
    const dayWorkouts = window.selectedDayWorkouts || [];
    const workout = dayWorkouts[workoutIdx];
    if (!workout) return;
    
    const detailsDiv = document.getElementById(`workout-details-${workoutIdx}`);
    if (detailsDiv.style.display === 'block') {
        detailsDiv.style.display = 'none';
        return;
    }
    
    let html = '';
    const groupedByMuscle = {};
    
    workout.exercises.forEach(ex => {
        const mg = ex.muscleGroup || 'Overig';
        if (!groupedByMuscle[mg]) groupedByMuscle[mg] = [];
        groupedByMuscle[mg].push(ex);
    });
    
    Object.entries(groupedByMuscle).forEach(([muscle, exercises]) => {
        html += `<div style="margin-bottom:0.75rem;">
            <strong style="color:var(--primary); display:block; margin-bottom:0.5rem;">${muscle}</strong>`;
        
        exercises.forEach(ex => {
            const completedSets = ex.sets.filter(s => s.completed).length;
            const totalSets = ex.sets.length;
            html += `<div style="font-size:0.85rem; margin-bottom:0.25rem; padding:0.35rem 0;">
                ${ex.name} • ${completedSets}/${totalSets} sets
            </div>`;
            
            ex.sets.forEach((set, sidx) => {
                html += `<div style="font-size:0.8rem; color:var(--text-muted); margin-left:1rem; ${set.completed ? 'opacity:0.7;' : ''}">
                    Set ${sidx + 1}: ${set.reps} × ${set.weight}kg ${set.completed ? '✓' : ''}
                </div>`;
            });
        });
        
        html += '</div>';
    });
    
    detailsDiv.innerHTML = html;
    detailsDiv.style.display = 'block';
}

function renderHistoryList() {
    const history = getWorkoutHistory();
    const container = document.getElementById('historyContainer');
    
    if (history.length === 0) {
        if (!document.getElementById('calendarContainer').innerHTML.includes('calendar-workout')) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon"></div>
                    <h3>Geen Workouts</h3>
                    <p>Start je eerste workout om geschiedenis te zien!</p>
                </div>
            `;
        }
        return;
    }
}

// PRS RENDERING
function renderPRs() {
    const prs = getPRs();
    const container = document.getElementById("prsContainer");
    const prList = Object.values(prs).sort((a, b) => new Date(b.date) - new Date(a.date));
    
    if (prList.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon"></div>
                <h3>Geen PRs</h3>
                <p>Voltooi workouts om persoonlijke records bij te houden!</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = `
        <div class="pr-list">
            ${prList.map(pr => `
                <div class="pr-card">
                    <div class="pr-card-header">
                        <div>
                            <div class="pr-card-title">${pr.exerciseName}</div>
                            <div class="pr-card-date">${formatDate(new Date(pr.date))}</div>
                        </div>
                        <div class="pr-value">${pr.weight}kg</div>
                    </div>
                    <div class="pr-card-stats">
                        <div class="pr-card-stat"><strong>${pr.reps}</strong> reps</div>
                        <div class="pr-card-stat"><strong>${pr.oneRM.toFixed(1)}kg</strong> 1RM</div>
                    </div>
                </div>
            `).join("")}
        </div>
    `;
}

// EXERCISES VIEW
function renderExercisesList() {
    const container = document.getElementById("exercisesList");
    if (!container) return;
    
    const customExercises = getCustomExercises();
    const allExercises = [];
    
    // Add standard exercises
    WORKOUT_DATA.schemas.forEach(schema => {
        schema.muscleGroups.forEach(group => {
            group.exercises.forEach(exercise => {
                allExercises.push({
                    ...exercise,
                    muscleGroup: group.name,
                    custom: false
                });
            });
        });
    });
    
    // Add custom exercises
    Object.values(customExercises).forEach(exercise => {
        allExercises.push({
            ...exercise,
            custom: true
        });
    });
    
    // Sort by name
    allExercises.sort((a, b) => a.name.localeCompare(b.name));
    
    if (allExercises.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon"></div>
                <h3>Geen oefeningen</h3>
                <p>Er zijn geen oefeningen beschikbaar.</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = allExercises.map(exercise => `
        <div class="exercise-item" style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--dark-card); border-radius: 12px; margin-bottom: 0.5rem; border: 1px solid var(--border);">
            <div>
                <div style="font-weight: 600; color: var(--text);">${exercise.name} ${exercise.custom ? '<span style="color: var(--primary);">⚡ Eigen</span>' : ''}</div>
                <div style="font-size: 0.875rem; color: var(--text-muted);">${exercise.muscleGroup} • MET ${exercise.met.toFixed(1)}</div>
            </div>
            ${exercise.custom ? `<button class="btn-icon delete-btn" onclick="deleteCustomExercise(${exercise.id})" title="Verwijderen">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 6h18M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2m3 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6h14M10 11v6m4-6v6"/>
                </svg>
            </button>` : ''}
        </div>
    `).join("");
}

function deleteCustomExercise(exerciseId) {
    if (!confirm('Weet je zeker dat je deze oefening wilt verwijderen?')) return;
    
    const custom = getCustomExercises();
    delete custom[exerciseId];
    saveCustomExercises(custom);
    renderExercisesList();
    showToast('Oefening verwijderd', 'success');
}

// PROGRESS VIEW
function renderProgress() {
    const container = document.getElementById("progressContainer");
    const history = getWorkoutHistory();
    if (!container) return;
    
    if (history.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon"></div>
                <h3>Geen data</h3>
                <p>Importeer of voltooi workouts om progressie te zien.</p>
            </div>
        `;
        return;
    }
    
    // Verzamel schema's
    const schemas = [];
    const schemaMap = {};
    history.forEach(w => {
        if (!schemaMap[w.schemaId]) {
            schemaMap[w.schemaId] = { id: w.schemaId, name: w.schemaName };
            schemas.push(schemaMap[w.schemaId]);
        }
    });
    if (schemas.length === 0) {
        container.innerHTML = `<div class="empty-state"><div class="empty-state-icon"></div><h3>Geen schema's</h3><p>Workouts missen schema-informatie.</p></div>`;
        return;
    }
    
    // Default selectie
    if (!progressState.schemaId || !schemaMap[progressState.schemaId]) {
        progressState.schemaId = schemas[0].id;
    }
    
    // Exercises per schema
    const exerciseMap = {};
    history.filter(w => w.schemaId === progressState.schemaId).forEach(w => {
        w.exercises.forEach(ex => {
            if (!exerciseMap[ex.id]) {
                exerciseMap[ex.id] = { id: ex.id, name: ex.name };
            }
        });
    });
    const exercises = Object.values(exerciseMap);
    if (exercises.length === 0) {
        container.innerHTML = `<div class="empty-state"><div class="empty-state-icon"></div><h3>Geen oefeningen</h3><p>Geen oefeningen gevonden voor dit schema.</p></div>`;
        return;
    }
    if (!progressState.exerciseId || !exerciseMap[progressState.exerciseId]) {
        progressState.exerciseId = exercises[0].id;
    }
    
    container.innerHTML = `
        <div style="display:flex; gap:1rem; flex-wrap:wrap; margin-bottom:1rem;">
            <div style="flex:1; min-width:200px;">
                <label style="font-weight:700; display:block; margin-bottom:0.35rem;">Schema</label>
                <select id="progressSchemaSelect" style="width:100%; padding:0.65rem; border-radius:12px; border:1px solid var(--border); background:var(--dark-card); color:var(--text);">
                    ${schemas.map(s => `<option value="${s.id}" ${s.id === progressState.schemaId ? 'selected' : ''}>${s.name}</option>`).join('')}
                </select>
            </div>
            <div style="flex:1; min-width:200px;">
                <label style="font-weight:700; display:block; margin-bottom:0.35rem;">Oefening</label>
                <select id="progressExerciseSelect" style="width:100%; padding:0.65rem; border-radius:12px; border:1px solid var(--border); background:var(--dark-card); color:var(--text);">
                    ${exercises.map(ex => `<option value="${ex.id}" ${ex.id === progressState.exerciseId ? 'selected' : ''}>${ex.name}</option>`).join('')}
                </select>
            </div>
        </div>

        <div style="background:var(--dark-card); border:1px solid var(--border); border-radius:16px; padding:1rem; box-shadow:var(--shadow);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem;">
                <div>
                    <div style="font-weight:800;">Progressie</div>
                    <div style="color:var(--text-muted); font-size:0.9rem;">Gewicht (kg) over tijd</div>
                </div>
                <div id="progressLegend" style="color:var(--text-muted); font-size:0.9rem;"></div>
            </div>
            <div id="progressChart" style="width:100%; height:260px;">
                <div style="text-align:center; color:var(--text-muted); padding:2rem;">Grafiek wordt geladen…</div>
            </div>
        </div>
    `;
    
    document.getElementById('progressSchemaSelect').addEventListener('change', (e) => {
        progressState.schemaId = e.target.value;
        progressState.exerciseId = null;
        renderProgress();
    });
    document.getElementById('progressExerciseSelect').addEventListener('change', (e) => {
        progressState.exerciseId = parseInt(e.target.value, 10);
        updateProgressChart();
    });
    
    // Initial render
    updateProgressChart();
}

function updateProgressChart() {
    const container = document.getElementById('progressChart');
    const legend = document.getElementById('progressLegend');
    if (!container) return;
    const history = getWorkoutHistory();
    if (!progressState.schemaId || !progressState.exerciseId) {
        container.innerHTML = `<div style="text-align:center; color:var(--text-muted); padding:2rem;">Selecteer een schema en oefening.</div>`;
        return;
    }
    
    const points = [];
    history.filter(w => w.schemaId === progressState.schemaId).forEach(w => {
        const ex = w.exercises.find(e => e.id === progressState.exerciseId);
        if (!ex) return;
        // Neem hoogste gewicht van voltooide sets; fallback op max weight
        let maxSet = ex.sets.reduce((best, s) => {
            const weight = parseFloat(s.weight || 0);
            const completed = !!s.completed;
            if (completed && weight > (best.weight || 0)) return { weight, reps: s.reps || 0 };
            if (!best.weight || weight > best.weight) return { weight, reps: s.reps || 0 };
            return best;
        }, { weight: 0, reps: 0 });
        points.push({
            date: new Date(w.startTime),
            weight: maxSet.weight || 0,
            reps: maxSet.reps || 0
        });
    });
    points.sort((a,b) => a.date - b.date);
    
    if (points.length === 0) {
        container.innerHTML = `<div style="text-align:center; color:var(--text-muted); padding:2rem;">Geen data voor deze oefening.</div>`;
        if (legend) legend.textContent = '';
        return;
    }
    
    // Y-bounds
    const weights = points.map(p => p.weight);
    const minY = Math.max(0, Math.min(...weights) - 5);
    const maxY = Math.max(...weights) + 5;
    const height = 200;
    const width = 100 * Math.max(points.length - 1, 1);
    const xStep = points.length > 1 ? width / (points.length - 1) : 0;
    
    const yScale = (w) => {
        if (maxY === minY) return height / 2;
        return height - ((w - minY) / (maxY - minY)) * height;
    };
    const xScale = (i) => i * xStep;
    
    // PR detection
    const prs = getPRs();
    const pr = prs[progressState.exerciseId?.toString()] || null;
    const hasPR = !!pr;
    const prWeight = pr?.weight || 0;
    
    const polylinePoints = points.map((p,i) => `${xScale(i)},${yScale(p.weight)}`).join(' ');
    const circles = points.map((p,i) => {
        const isPR = hasPR && p.weight >= prWeight;
        return `<circle cx="${xScale(i)}" cy="${yScale(p.weight)}" r="4" fill="${isPR ? '#FFCC00' : '#34C759'}" stroke="${isPR ? '#FF9500' : 'none'}" />`;
    }).join('');
    
    const labels = points.map((p,i) => {
        const dateStr = `${p.date.getDate()}-${p.date.getMonth()+1}-${p.date.getFullYear()}`;
        const isPR = hasPR && p.weight >= prWeight;
        return `<text x="${xScale(i)}" y="${yScale(p.weight)-10}" fill="${isPR ? '#FFCC00' : '#8E8E93'}" font-size="10" text-anchor="middle">${p.weight}kg</text>
                <text x="${xScale(i)}" y="${height+18}" fill="#8E8E93" font-size="10" text-anchor="middle">${dateStr}</text>`;
    }).join('');
    
    container.innerHTML = `
        <svg viewBox="0 0 ${width} ${height+30}" preserveAspectRatio="xMidYMax meet" style="width:100%; height:240px;">
            <polyline fill="none" stroke="#34C759" stroke-width="3" points="${polylinePoints}" stroke-linecap="round" stroke-linejoin="round"></polyline>
            ${circles}
            ${labels}
        </svg>
    `;
    if (legend) {
        legend.innerHTML = hasPR ? `PR: ${prWeight}kg <span style="color:#FFCC00; margin-left:0.5rem;">★</span>` : '';
    }
}

// VIEW SWITCHING
function switchView(viewName) {
    currentView = viewName;
    
    // Update tabs
    document.querySelectorAll(".tab").forEach(tab => {
        tab.classList.toggle("active", tab.dataset.view === viewName);
    });
    
    // Update views
    document.querySelectorAll(".view").forEach(view => {
        view.classList.remove("active");
    });
    
    const viewMap = {
        "workout": "workoutView",
        "history": "historyView",
        "progress": "progressView",
        "prs": "prsView",
        "exercises": "exercisesView",
        "settings": "settingsView",
        "schemas": "schemasView"
    };
    
    const targetViewId = viewMap[viewName];
    const targetEl = targetViewId ? document.getElementById(targetViewId) : null;
    if (targetEl && targetEl.classList) {
        targetEl.classList.add("active");
    } else {
        console.warn('switchView: target view not found', viewName, targetViewId);
    }
    
    // Render content
    if (viewName === "history") renderHistory();
    if (viewName === "prs") renderPRs();
    if (viewName === "progress") renderProgress();
    if (viewName === "exercises") {
        renderExercisesList();
        document.getElementById("fabAddExercise").classList.add("visible");
    } else if (viewName === "schemas") {
        // Render schema beheer UI when switching to schemas
        try { renderCustomSchemasList(); } catch (e) { console.warn('renderCustomSchemasList failed', e); }
    } else if (viewName !== "workout") {
        // Hide FAB unless in exercises view or workout view (workout view handles FAB in selectSchema)
        document.getElementById("fabAddExercise").classList.remove("visible");
    }
    if (viewName === "settings") updateSettingsUI();
}

// Ensure a view is visible after full load (defensive, avoids black screen)
window.addEventListener('load', function() {
    try {
        const anyActive = document.querySelector('.view.active');
        if (!anyActive) {
            // Use currentView fallback or default to workout
            switchView(typeof currentView === 'string' ? currentView : 'workout');
        }
    } catch (e) {
        console.warn('Error ensuring active view on load', e);
        try { switchView('workout'); } catch (err) {}
    }
});

// BACKUP & IMPORT
function exportBackup() {
    const data = {
        workouts: getWorkoutHistory(),
        prs: getPRs(),
        settings: getSettings(),
        exportDate: new Date().toISOString()
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `gym-tracker-backup-${formatDate(new Date())}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    showToast("Backup gedownload!", "success");
}

function importBackup() {
    document.getElementById("importFileInput").click();
}

function handleImportFile(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            
            if (data.workouts) localStorage.setItem("workout_history", JSON.stringify(data.workouts));
            if (data.prs) localStorage.setItem("workout_prs", JSON.stringify(data.prs));
            if (data.settings) localStorage.setItem("gym_settings", JSON.stringify(data.settings));
            
            showToast("Backup succesvol geïmporteerd!", "success");
            
            // Refresh views
            renderHistory();
            renderPRs();
            loadSettings();
        } catch (error) {
            showToast("Ongeldige backup file", "error");
        }
    };
    reader.readAsText(file);
    
    // Reset input
    event.target.value = "";
}

// MODALS
function openModal(modalId) {
    document.getElementById(modalId).classList.add("active");
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove("active");
}

// TOAST
function showToast(message, type = "success") {
    const toast = document.getElementById("toast");
    toast.textContent = message;
    toast.className = `toast ${type}`;
    toast.classList.add("show");
    
    setTimeout(() => {
        toast.classList.remove("show");
    }, 3000);
}

// UTILITY
function formatDate(date) {
    const options = { day: "numeric", month: "long", year: "numeric" };
    return date.toLocaleDateString("nl-NL", options);
}

function formatTime(date) {
    return date.toLocaleTimeString("nl-NL", { hour: "2-digit", minute: "2-digit" });
}

function formatDuration(seconds) {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    
    if (hours > 0) {
        return `${hours}u ${minutes}m`;
    }
    return `${minutes}m`;
}

function loadSettings() {
    const settings = getSettings();
    const bodyWeightInput = document.getElementById("bodyWeightInput");
    const defaultSetsInput = document.getElementById("defaultSetsInput");

    if (bodyWeightInput) bodyWeightInput.value = settings.bodyWeight;
    if (defaultSetsInput) defaultSetsInput.value = settings.defaultSets;
}

// DARK MODE THEME MANAGEMENT
function loadTheme() {
    const savedTheme = localStorage.getItem('gym_theme') || 'dark';
    applyTheme(savedTheme === 'dark');
}

function applyTheme(isDarkMode) {
    document.body.classList.toggle('light-mode', !isDarkMode);
    updateThemeToggle(isDarkMode);
}

function toggleDarkMode() {
    const currentlyDark = !document.body.classList.contains('light-mode');
    const newIsDark = !currentlyDark; // flip
    applyTheme(newIsDark);
    localStorage.setItem('gym_theme', newIsDark ? 'dark' : 'light');
}

function toggleLogging() {
    const settings = getSettings();
    const newLoggingEnabled = !settings.loggingEnabled;
    settings.loggingEnabled = newLoggingEnabled;
    saveSettings(settings);
    updateLoggingToggle(newLoggingEnabled);
}

function updateThemeToggle(isDarkMode) {
    const toggle = document.getElementById('themeToggle');
    if (toggle) {
        // active state indicates Dark Mode ON
        toggle.classList.toggle('active', isDarkMode);
    }
}

function updateLoggingToggle(isLoggingEnabled) {
    const toggle = document.getElementById('loggingToggle');
    if (toggle) {
        toggle.classList.toggle('active', isLoggingEnabled);
    }
    const logBtn = document.getElementById('showConsoleLogBtn');
    if (logBtn) {
        logBtn.style.display = isLoggingEnabled ? 'block' : 'none';
    }
}

function updateSettingsUI() {
    const settings = getSettings();
    const isDarkMode = !document.body.classList.contains('light-mode');
    
    // Update body weight input
    const bodyWeightInput = document.getElementById('bodyWeightInput');
    if (bodyWeightInput) {
        bodyWeightInput.value = settings.bodyWeight;
    }
    
    // Update default sets input
    const defaultSetsInput = document.getElementById('defaultSetsInput');
    if (defaultSetsInput) {
        defaultSetsInput.value = settings.defaultSets;
    }
    
    // Update theme toggle
    updateThemeToggle(isDarkMode);
    
    // Update logging toggle
    updateLoggingToggle(settings.loggingEnabled);
}

function updateBodyWeight(value) {
    const weight = Math.max(30, Math.min(200, parseInt(value) || 75));
    document.getElementById('bodyWeightInput').value = weight;
    const settings = getSettings();
    settings.bodyWeight = weight;
    saveSettings(settings);
}

function updateDefaultSets(value) {
    const sets = Math.max(1, Math.min(10, parseInt(value) || 3));
    document.getElementById('defaultSetsInput').value = sets;
    const settings = getSettings();
    settings.defaultSets = sets;
    saveSettings(settings);
}

// Initialize on load
document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
